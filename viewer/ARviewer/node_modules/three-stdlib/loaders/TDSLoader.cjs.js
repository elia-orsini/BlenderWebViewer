"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("three");class t extends e.Loader{constructor(e){super(e),this.debug=!1,this.group=null,this.position=0,this.materials=[],this.meshes=[]}load(t,s,i,r){const a=this,n=""===this.path?e.LoaderUtils.extractUrlBase(t):this.path,h=new e.FileLoader(this.manager);h.setPath(this.path),h.setResponseType("arraybuffer"),h.setRequestHeader(this.requestHeader),h.setWithCredentials(this.withCredentials),h.load(t,(function(e){try{s(a.parse(e,n))}catch(e){r?r(e):console.error(e),a.manager.itemError(t)}}),i,r)}parse(t,s){this.group=new e.Group,this.position=0,this.materials=[],this.meshes=[],this.readFile(t,s);for(let e=0;e<this.meshes.length;e++)this.group.add(this.meshes[e]);return this.group}readFile(e,t){const n=new DataView(e),h=this.readChunk(n);if(h.id===i||h.id===r||h.id===s){let e=this.nextChunk(n,h);for(;0!==e;){if(e===a){const e=this.readDWord(n);this.debugMessage("3DS file version: "+e)}else e===g?(this.resetPosition(n),this.readMeshData(n,t)):this.debugMessage("Unknown main chunk: "+e.toString(16));e=this.nextChunk(n,h)}}this.debugMessage("Parsed "+this.meshes.length+" meshes")}readMeshData(e,t){const s=this.readChunk(e);let i=this.nextChunk(e,s);for(;0!==i;){if(i===c){const t=+this.readDWord(e);this.debugMessage("Mesh Version: "+t)}else if(i===p){const t=this.readFloat(e);this.debugMessage("Master scale: "+t),this.group.scale.set(t,t,t)}else i===T?(this.debugMessage("Named Object"),this.resetPosition(e),this.readNamedObject(e)):i===M?(this.debugMessage("Material"),this.resetPosition(e),this.readMaterialEntry(e,t)):this.debugMessage("Unknown MDATA chunk: "+i.toString(16));i=this.nextChunk(e,s)}}readNamedObject(e){const t=this.readChunk(e),s=this.readString(e,64);t.cur=this.position;let i=this.nextChunk(e,t);for(;0!==i;){if(i===L){this.resetPosition(e);const t=this.readMesh(e);t.name=s,this.meshes.push(t)}else this.debugMessage("Unknown named object chunk: "+i.toString(16));i=this.nextChunk(e,t)}this.endChunk(t)}readMaterialEntry(t,s){const i=this.readChunk(t);let r=this.nextChunk(t,i);const a=new e.MeshPhongMaterial;for(;0!==r;){if(r===f)a.name=this.readString(t,64),this.debugMessage("   Name: "+a.name);else if(r===F)this.debugMessage("   Wireframe"),a.wireframe=!0;else if(r===S){const e=this.readByte(t);a.wireframeLinewidth=e,this.debugMessage("   Wireframe Thickness: "+e)}else if(r===x)a.side=e.DoubleSide,this.debugMessage("   DoubleSided");else if(r===w)this.debugMessage("   Additive Blending"),a.blending=e.AdditiveBlending;else if(r===b)this.debugMessage("   Diffuse Color"),a.color=this.readColor(t);else if(r===k)this.debugMessage("   Specular Color"),a.specular=this.readColor(t);else if(r===m)this.debugMessage("   Ambient color"),a.color=this.readColor(t);else if(r===C){const e=this.readPercentage(t);a.shininess=100*e,this.debugMessage("   Shininess : "+e)}else if(r===y){const e=this.readPercentage(t);a.opacity=1-e,this.debugMessage("  Transparency : "+e),a.transparent=a.opacity<1}else r===P?(this.debugMessage("   ColorMap"),this.resetPosition(t),a.map=this.readMap(t,s)):r===U?(this.debugMessage("   BumpMap"),this.resetPosition(t),a.bumpMap=this.readMap(t,s)):r===W?(this.debugMessage("   OpacityMap"),this.resetPosition(t),a.alphaMap=this.readMap(t,s)):r===B?(this.debugMessage("   SpecularMap"),this.resetPosition(t),a.specularMap=this.readMap(t,s)):this.debugMessage("   Unknown material chunk: "+r.toString(16));r=this.nextChunk(t,i)}this.endChunk(i),this.materials[a.name]=a}readMesh(t){const s=this.readChunk(t);let i=this.nextChunk(t,s);const r=new e.BufferGeometry,a=new e.MeshPhongMaterial,n=new e.Mesh(r,a);for(n.name="mesh";0!==i;){if(i===N){const s=this.readWord(t);this.debugMessage("   Vertex: "+s);const i=[];for(let e=0;e<s;e++)i.push(this.readFloat(t)),i.push(this.readFloat(t)),i.push(this.readFloat(t));r.setAttribute("position",new e.Float32BufferAttribute(i,3))}else if(i===R)this.resetPosition(t),this.readFaceArray(t,n);else if(i===V){const s=this.readWord(t);this.debugMessage("   UV: "+s);const i=[];for(let e=0;e<s;e++)i.push(this.readFloat(t)),i.push(this.readFloat(t));r.setAttribute("uv",new e.Float32BufferAttribute(i,2))}else if(i===q){this.debugMessage("   Tranformation Matrix (TODO)");const s=[];for(let e=0;e<12;e++)s[e]=this.readFloat(t);const i=new e.Matrix4;i.elements[0]=s[0],i.elements[1]=s[6],i.elements[2]=s[3],i.elements[3]=s[9],i.elements[4]=s[2],i.elements[5]=s[8],i.elements[6]=s[5],i.elements[7]=s[11],i.elements[8]=s[1],i.elements[9]=s[7],i.elements[10]=s[4],i.elements[11]=s[10],i.elements[12]=0,i.elements[13]=0,i.elements[14]=0,i.elements[15]=1,i.transpose();const a=new e.Matrix4;a.copy(i).invert(),r.applyMatrix4(a),i.decompose(n.position,n.quaternion,n.scale)}else this.debugMessage("   Unknown mesh chunk: "+i.toString(16));i=this.nextChunk(t,s)}return this.endChunk(s),r.computeVertexNormals(),n}readFaceArray(e,t){const s=this.readChunk(e),i=this.readWord(e);this.debugMessage("   Faces: "+i);const r=[];for(let t=0;t<i;++t)r.push(this.readWord(e),this.readWord(e),this.readWord(e)),this.readWord(e);t.geometry.setIndex(r);let a=0,n=0;for(;this.position<s.end;){const s=this.readChunk(e);if(s.id===j){this.debugMessage("      Material Group"),this.resetPosition(e);const s=this.readMaterialGroup(e),i=3*s.index.length;t.geometry.addGroup(n,i,a),n+=i,a++;const r=this.materials[s.name];!1===Array.isArray(t.material)&&(t.material=[]),void 0!==r&&t.material.push(r)}else this.debugMessage("      Unknown face array chunk: "+s.toString(16));this.endChunk(s)}1===t.material.length&&(t.material=t.material[0]),this.endChunk(s)}readMap(t,s){const i=this.readChunk(t);let r=this.nextChunk(t,i),a={};const n=new e.TextureLoader(this.manager);for(n.setPath(this.resourcePath||s).setCrossOrigin(this.crossOrigin);0!==r;){if(r===D){const e=this.readString(t,128);a=n.load(e),this.debugMessage("      File: "+s+e)}else r===v?(a.offset.x=this.readFloat(t),this.debugMessage("      OffsetX: "+a.offset.x)):r===G?(a.offset.y=this.readFloat(t),this.debugMessage("      OffsetY: "+a.offset.y)):r===A?(a.repeat.x=this.readFloat(t),this.debugMessage("      RepeatX: "+a.repeat.x)):r===O?(a.repeat.y=this.readFloat(t),this.debugMessage("      RepeatY: "+a.repeat.y)):this.debugMessage("      Unknown map chunk: "+r.toString(16));r=this.nextChunk(t,i)}return this.endChunk(i),a}readMaterialGroup(e){this.readChunk(e);const t=this.readString(e,64),s=this.readWord(e);this.debugMessage("         Name: "+t),this.debugMessage("         Faces: "+s);const i=[];for(let t=0;t<s;++t)i.push(this.readWord(e));return{name:t,index:i}}readColor(t){const s=this.readChunk(t),i=new e.Color;if(s.id===h||s.id===o){const e=this.readByte(t),s=this.readByte(t),r=this.readByte(t);i.setRGB(e/255,s/255,r/255),this.debugMessage("      Color: "+i.r+", "+i.g+", "+i.b)}else if(s.id===n||s.id===d){const e=this.readFloat(t),s=this.readFloat(t),r=this.readFloat(t);i.setRGB(e,s,r),this.debugMessage("      Color: "+i.r+", "+i.g+", "+i.b)}else this.debugMessage("      Unknown color chunk: "+s.toString(16));return this.endChunk(s),i}readChunk(e){const t={};return t.cur=this.position,t.id=this.readWord(e),t.size=this.readDWord(e),t.end=t.cur+t.size,t.cur+=6,t}endChunk(e){this.position=e.end}nextChunk(e,t){if(t.cur>=t.end)return 0;this.position=t.cur;try{const s=this.readChunk(e);return t.cur+=s.size,s.id}catch(e){return this.debugMessage("Unable to read chunk at "+this.position),0}}resetPosition(){this.position-=6}readByte(e){const t=e.getUint8(this.position,!0);return this.position+=1,t}readFloat(e){try{const t=e.getFloat32(this.position,!0);return this.position+=4,t}catch(t){this.debugMessage(t+" "+this.position+" "+e.byteLength)}}readInt(e){const t=e.getInt32(this.position,!0);return this.position+=4,t}readShort(e){const t=e.getInt16(this.position,!0);return this.position+=2,t}readDWord(e){const t=e.getUint32(this.position,!0);return this.position+=4,t}readWord(e){const t=e.getUint16(this.position,!0);return this.position+=2,t}readString(e,t){let s="";for(let i=0;i<t;i++){const t=this.readByte(e);if(!t)break;s+=String.fromCharCode(t)}return s}readPercentage(e){const t=this.readChunk(e);let s;switch(t.id){case u:s=this.readShort(e)/100;break;case l:s=this.readFloat(e);break;default:this.debugMessage("      Unknown percentage chunk: "+t.toString(16))}return this.endChunk(t),s}debugMessage(e){this.debug&&console.log(e)}}const s=19789,i=15786,r=49725,a=2,n=16,h=17,o=18,d=19,u=48,l=49,g=15677,c=15678,p=256,M=45055,f=40960,m=40976,b=40992,k=41008,C=41024,y=41040,x=41089,w=41091,F=41093,S=41095,P=41472,W=41488,U=41520,B=41476,D=41728,A=41812,O=41814,v=41816,G=41818,T=16384,L=16640,N=16656,R=16672,j=16688,V=16704,q=16736;exports.TDSLoader=t;
