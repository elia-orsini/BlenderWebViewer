"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("three"),t=require("fflate"),r=require("../misc/Volume.cjs.js");require("../misc/VolumeSlice.cjs.js");class n extends e.Loader{constructor(e){super(e)}load(t,r,n,s){const a=this,i=new e.FileLoader(a.manager);i.setPath(a.path),i.setResponseType("arraybuffer"),i.setRequestHeader(a.requestHeader),i.setWithCredentials(a.withCredentials),i.load(t,(function(e){try{r(a.parse(e))}catch(e){s?s(e):console.error(e),a.manager.itemError(t)}}),n,s)}parse(n){let a=n,i=0;const o=new Int8Array(new Int16Array([1]).buffer)[0]>0,c={};const u=function(e,t){null==t&&(t=1);let r=1,n=Uint8Array;switch(e){case"uchar":break;case"schar":n=Int8Array;break;case"ushort":n=Uint16Array,r=2;break;case"sshort":n=Int16Array,r=2;break;case"uint":n=Uint32Array,r=4;break;case"sint":n=Int32Array,r=4;break;case"float":n=Float32Array,r=4;break;case"complex":case"double":n=Float64Array,r=8}let s=new n(a.slice(i,i+=t*r));return true!=o&&(s=function(e,t){const r=new Uint8Array(e.buffer,e.byteOffset,e.byteLength);for(let n=0;n<e.byteLength;n+=t)for(let e=n+t-1,s=n;e>s;e--,s++){const t=r[s];r[s]=r[e],r[e]=t}return e}(s,r)),1==t?s[0]:s}("uchar",n.byteLength),l=u.length;let h,p=null,d=0;for(h=1;h<l;h++)if(10==u[h-1]&&10==u[h]){p=this.parseChars(u,0,h-2),d=h+1;break}if(function(t){let r,n,a,i,o,u,l,h;const p=t.split(/\r?\n/);for(l=0,h=p.length;l<h;l++)o=p[l],o.match(/NRRD\d+/)?c.isNrrd=!0:o.match(/^#/)||(u=o.match(/(.*):(.*)/))&&(n=u[1].trim(),r=u[2].trim(),a=s[n],a?a.call(c,r):c[n]=r);if(!c.isNrrd)throw new Error("Not an NRRD file");if("bz2"===c.encoding||"bzip2"===c.encoding)throw new Error("Bzip is not supported");if(!c.vectors&&(c.vectors=[new e.Vector3(1,0,0),new e.Vector3(0,1,0),new e.Vector3(0,0,1)],c.spacings))for(i=0;i<=2;i++)isNaN(c.spacings[i])||c.vectors[i].multiplyScalar(c.spacings[i])}(p),a=u.subarray(d),"gz"===c.encoding.substring(0,2))a=t.gunzipSync(new Uint8Array(a));else if("ascii"===c.encoding||"text"===c.encoding||"txt"===c.encoding||"hex"===c.encoding)a=function(e,t,r){let n,s="";t=t||0,r=r||e.length;const a=c.sizes.reduce((function(e,t){return e*t}),1);let i=10;"hex"===c.encoding&&(i=16);const o=new c.__array(a);let u=0,l=parseInt;c.__array!==Float32Array&&c.__array!==Float64Array||(l=parseFloat);for(let a=t;a<r;a++)n=e[a],(n<9||n>13)&&32!==n?s+=String.fromCharCode(n):(""!==s&&(o[u]=l(s,i),u++),s="");return""!==s&&(o[u]=l(s,i),u++),o}(a);else if("raw"===c.encoding){const e=new Uint8Array(a.length);for(let t=0;t<a.length;t++)e[t]=a[t];a=e}a=a.buffer;const f=new r.Volume;f.header=c,f.data=new c.__array(a);const g=f.computeMinMax(),y=g[0],w=g[1];f.windowLow=y,f.windowHigh=w,f.dimensions=[c.sizes[0],c.sizes[1],c.sizes[2]],f.xLength=f.dimensions[0],f.yLength=f.dimensions[1],f.zLength=f.dimensions[2];const _=new e.Vector3(c.vectors[0][0],c.vectors[0][1],c.vectors[0][2]).length(),b=new e.Vector3(c.vectors[1][0],c.vectors[1][1],c.vectors[1][2]).length(),m=new e.Vector3(c.vectors[2][0],c.vectors[2][1],c.vectors[2][2]).length();f.spacing=[_,b,m],f.matrix=new e.Matrix4;let A=1,v=1;if("left-posterior-superior"==c.space?(A=-1,v=-1):"left-anterior-superior"===c.space&&(A=-1),c.vectors){const e=c.vectors;f.matrix.set(A*e[0][0],A*e[1][0],A*e[2][0],0,v*e[0][1],v*e[1][1],v*e[2][1],0,1*e[0][2],1*e[1][2],1*e[2][2],0,0,0,0,1)}else f.matrix.set(A,0,0,0,0,v,0,0,0,0,1,0,0,0,0,1);return f.inverseMatrix=new e.Matrix4,f.inverseMatrix.copy(f.matrix).invert(),f.RASDimensions=new e.Vector3(f.xLength,f.yLength,f.zLength).applyMatrix4(f.matrix).round().toArray().map(Math.abs),f.lowerThreshold===-1/0&&(f.lowerThreshold=y),f.upperThreshold===1/0&&(f.upperThreshold=w),f}parseChars(e,t,r){void 0===t&&(t=0),void 0===r&&(r=e.length);let n="",s=0;for(s=t;s<r;++s)n+=String.fromCharCode(e[s]);return n}}const s={type:function(e){switch(e){case"uchar":case"unsigned char":case"uint8":case"uint8_t":this.__array=Uint8Array;break;case"signed char":case"int8":case"int8_t":this.__array=Int8Array;break;case"short":case"short int":case"signed short":case"signed short int":case"int16":case"int16_t":this.__array=Int16Array;break;case"ushort":case"unsigned short":case"unsigned short int":case"uint16":case"uint16_t":this.__array=Uint16Array;break;case"int":case"signed int":case"int32":case"int32_t":this.__array=Int32Array;break;case"uint":case"unsigned int":case"uint32":case"uint32_t":this.__array=Uint32Array;break;case"float":this.__array=Float32Array;break;case"double":this.__array=Float64Array;break;default:throw new Error("Unsupported NRRD data type: "+e)}return this.type=e},endian:function(e){return this.endian=e},encoding:function(e){return this.encoding=e},dimension:function(e){return this.dim=parseInt(e,10)},sizes:function(e){let t;return this.sizes=function(){const r=e.split(/\s+/),n=[];for(let e=0,s=r.length;e<s;e++)t=r[e],n.push(parseInt(t,10));return n}()},space:function(e){return this.space=e},"space origin":function(e){return this.space_origin=e.split("(")[1].split(")")[0].split(",")},"space directions":function(e){let t,r;const n=e.match(/\(.*?\)/g);return this.vectors=function(){const e=[];for(let s=0,a=n.length;s<a;s++)r=n[s],e.push(function(){const e=r.slice(1,-1).split(/,/),n=[];for(let r=0,s=e.length;r<s;r++)t=e[r],n.push(parseFloat(t));return n}());return e}()},spacings:function(e){let t;const r=e.split(/\s+/);return this.spacings=function(){const e=[];for(let n=0,s=r.length;n<s;n++)t=r[n],e.push(parseFloat(t));return e}()}};exports.NRRDLoader=n;
