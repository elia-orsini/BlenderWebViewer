"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("three");class t extends e.Loader{constructor(e){super(e),this.animateBonePositions=!0,this.animateBoneRotations=!0}load(t,o,n,r){const s=this,a=new e.FileLoader(s.manager);a.setPath(s.path),a.setRequestHeader(s.requestHeader),a.setWithCredentials(s.withCredentials),a.load(t,(function(e){try{o(s.parse(e))}catch(e){r?r(e):console.error(e),s.manager.itemError(t)}}),n,r)}parse(t){function o(t,n,r){if("ENDSITE"===r.type)return;const s={time:n,position:new e.Vector3,rotation:new e.Quaternion};r.frames.push(s);const a=new e.Quaternion,i=new e.Vector3(1,0,0),l=new e.Vector3(0,1,0),p=new e.Vector3(0,0,1);for(let e=0;e<r.channels.length;e++)switch(r.channels[e]){case"Xposition":s.position.x=parseFloat(t.shift().trim());break;case"Yposition":s.position.y=parseFloat(t.shift().trim());break;case"Zposition":s.position.z=parseFloat(t.shift().trim());break;case"Xrotation":a.setFromAxisAngle(i,parseFloat(t.shift().trim())*Math.PI/180),s.rotation.multiply(a);break;case"Yrotation":a.setFromAxisAngle(l,parseFloat(t.shift().trim())*Math.PI/180),s.rotation.multiply(a);break;case"Zrotation":a.setFromAxisAngle(p,parseFloat(t.shift().trim())*Math.PI/180),s.rotation.multiply(a);break;default:console.warn("THREE.BVHLoader: Invalid channel type.")}for(let e=0;e<r.children.length;e++)o(t,n,r.children[e])}function n(t,o,s){const a={name:"",type:"",frames:[]};s.push(a);let i=o.split(/[\s]+/);"END"===i[0].toUpperCase()&&"SITE"===i[1].toUpperCase()?(a.type="ENDSITE",a.name="ENDSITE"):(a.name=i[1],a.type=i[0].toUpperCase()),"{"!==r(t)&&console.error("THREE.BVHLoader: Expected opening { after type & name"),i=r(t).split(/[\s]+/),"OFFSET"!==i[0]&&console.error("THREE.BVHLoader: Expected OFFSET but got: "+i[0]),4!==i.length&&console.error("THREE.BVHLoader: Invalid number of values for OFFSET.");const l=new e.Vector3(parseFloat(i[1]),parseFloat(i[2]),parseFloat(i[3]));if((isNaN(l.x)||isNaN(l.y)||isNaN(l.z))&&console.error("THREE.BVHLoader: Invalid values of OFFSET."),a.offset=l,"ENDSITE"!==a.type){i=r(t).split(/[\s]+/),"CHANNELS"!==i[0]&&console.error("THREE.BVHLoader: Expected CHANNELS definition.");const e=parseInt(i[1]);a.channels=i.splice(2,e),a.children=[]}for(;;){const e=r(t);if("}"===e)return a;a.children.push(n(t,e,s))}}function r(e){let t;for(;0===(t=e.shift().trim()).length;);return t}const s=this,a=function(e){"HIERARCHY"!==r(e)&&console.error("THREE.BVHLoader: HIERARCHY expected.");const t=[],s=n(e,r(e),t);"MOTION"!==r(e)&&console.error("THREE.BVHLoader: MOTION expected.");let a=r(e).split(/[\s]+/);const i=parseInt(a[1]);isNaN(i)&&console.error("THREE.BVHLoader: Failed to read number of frames."),a=r(e).split(/[\s]+/);const l=parseFloat(a[2]);isNaN(l)&&console.error("THREE.BVHLoader: Failed to read frame time.");for(let t=0;t<i;t++)a=r(e).split(/[\s]+/),o(a,t*l,s);return t}(t.split(/[\r\n]+/g)),i=[];!function t(o,n){const r=new e.Bone;if(n.push(r),r.position.add(o.offset),r.name=o.name,"ENDSITE"!==o.type)for(let e=0;e<o.children.length;e++)r.add(t(o.children[e],n));return r}(a[0],i);const l=function(t){const o=[];for(let n=0;n<t.length;n++){const r=t[n];if("ENDSITE"===r.type)continue;const a=[],i=[],l=[];for(let e=0;e<r.frames.length;e++){const t=r.frames[e];a.push(t.time),i.push(t.position.x+r.offset.x),i.push(t.position.y+r.offset.y),i.push(t.position.z+r.offset.z),l.push(t.rotation.x),l.push(t.rotation.y),l.push(t.rotation.z),l.push(t.rotation.w)}s.animateBonePositions&&o.push(new e.VectorKeyframeTrack(".bones["+r.name+"].position",a,i)),s.animateBoneRotations&&o.push(new e.QuaternionKeyframeTrack(".bones["+r.name+"].quaternion",a,l))}return new e.AnimationClip("animation",-1,o)}(a);return{skeleton:new e.Skeleton(i),clip:l}}}exports.BVHLoader=t;
