"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("three"),t=require("./TGALoader.cjs.js");class n extends e.Loader{constructor(e){super(e)}load(t,n,s,o){const i=this,r=""===i.path?e.LoaderUtils.extractUrlBase(t):i.path,a=new e.FileLoader(i.manager);a.setPath(i.path),a.setRequestHeader(i.requestHeader),a.setWithCredentials(i.withCredentials),a.load(t,(function(e){try{n(i.parse(e,r))}catch(e){o?o(e):console.error(e),i.manager.itemError(t)}}),s,o)}parse(n,s){function o(e,t){const n=[],s=e.childNodes;for(let e=0,o=s.length;e<o;e++){const o=s[e];o.nodeName===t&&n.push(o)}return n}function i(e){if(0===e.length)return[];const t=e.trim().split(/\s+/),n=new Array(t.length);for(let e=0,s=t.length;e<s;e++)n[e]=t[e];return n}function r(e){if(0===e.length)return[];const t=e.trim().split(/\s+/),n=new Array(t.length);for(let e=0,s=t.length;e<s;e++)n[e]=parseFloat(t[e]);return n}function a(e){if(0===e.length)return[];const t=e.trim().split(/\s+/),n=new Array(t.length);for(let e=0,s=t.length;e<s;e++)n[e]=parseInt(t[e]);return n}function c(e){return e.substring(1)}function l(e){return 0===Object.keys(e).length}function d(e){return void 0!==e&&!0===e.hasAttribute("meter")?parseFloat(e.getAttribute("meter")):1}function u(e){return void 0!==e?e.textContent:"Y_UP"}function f(e,t,n,s){const i=o(e,t)[0];if(void 0!==i){const e=o(i,n);for(let t=0;t<e.length;t++)s(e[t])}}function h(e,t){for(const n in e){e[n].build=t(e[n])}}function m(e,t){return void 0!==e.build||(e.build=t(e)),e.build}function p(e){const t={inputs:{}};for(let n=0,s=e.childNodes.length;n<s;n++){const s=e.childNodes[n];if(1===s.nodeType)switch(s.nodeName){case"input":const e=c(s.getAttribute("source")),n=s.getAttribute("semantic");t.inputs[n]=e}}return t}function g(e){const t={};let n=e.getAttribute("target").split("/");const s=n.shift();let o=n.shift();const i=-1!==o.indexOf("("),r=-1!==o.indexOf(".");if(r)n=o.split("."),o=n.shift(),t.member=n.shift();else if(i){const e=o.split("(");o=e.shift();for(let t=0;t<e.length;t++)e[t]=parseInt(e[t].replace(/\)/,""));t.indices=e}return t.id=s,t.sid=o,t.arraySyntax=i,t.memberSyntax=r,t.sampler=c(e.getAttribute("source")),t}function b(e){const t=[],n=e.channels,s=e.samplers,o=e.sources;for(const e in n)if(n.hasOwnProperty(e)){const i=n[e],r=s[i.sampler],a=r.inputs.INPUT,c=r.inputs.OUTPUT;A(N(i,o[a],o[c]),t)}return t}function y(e){return m(Qe.animations[e],b)}function N(e,t,n){const s=Qe.nodes[e.id],o=Fe(s.id),i=s.transforms[e.sid],r=s.matrix.clone().transpose();let a,c,l,d,u,f;const h={};switch(i){case"matrix":for(l=0,d=t.array.length;l<d;l++)if(a=t.array[l],c=l*n.stride,void 0===h[a]&&(h[a]={}),!0===e.arraySyntax){const t=n.array[c],s=e.indices[0]+4*e.indices[1];h[a][s]=t}else for(u=0,f=n.stride;u<f;u++)h[a][u]=n.array[c+u];break;case"translate":case"rotate":case"scale":console.warn('THREE.ColladaLoader: Animation transform type "%s" not yet implemented.',i)}const m=function(e,t){const n=[];for(const t in e)n.push({time:parseFloat(t),value:e[t]});n.sort(s);for(let e=0;e<16;e++)v(n,e,t.elements[e]);return n;function s(e,t){return e.time-t.time}}(h,r);return{name:o.uuid,keyframes:m}}const w=new e.Vector3,x=new e.Vector3,k=new e.Quaternion;function A(t,n){const s=t.keyframes,o=t.name,i=[],r=[],a=[],c=[];for(let e=0,t=s.length;e<t;e++){const t=s[e],n=t.time,o=t.value;_e.fromArray(o).transpose(),_e.decompose(w,k,x),i.push(n),r.push(w.x,w.y,w.z),a.push(k.x,k.y,k.z,k.w),c.push(x.x,x.y,x.z)}return r.length>0&&n.push(new e.VectorKeyframeTrack(o+".position",i,r)),a.length>0&&n.push(new e.QuaternionKeyframeTrack(o+".quaternion",i,a)),c.length>0&&n.push(new e.VectorKeyframeTrack(o+".scale",i,c)),n}function v(e,t,n){let s,o,i,r=!0;for(o=0,i=e.length;o<i;o++)s=e[o],void 0===s.value[t]?s.value[t]=null:r=!1;if(!0===r)for(o=0,i=e.length;o<i;o++)s=e[o],s.value[t]=n;else!function(e,t){let n,s;for(let o=0,i=e.length;o<i;o++){const i=e[o];if(null===i.value[t]){if(n=T(e,o,t),s=C(e,o,t),null===n){i.value[t]=s.value[t];continue}if(null===s){i.value[t]=n.value[t];continue}_(i,n,s,t)}}}(e,t)}function T(e,t,n){for(;t>=0;){const s=e[t];if(null!==s.value[n])return s;t--}return null}function C(e,t,n){for(;t<e.length;){const s=e[t];if(null!==s.value[n])return s;t++}return null}function _(e,t,n,s){n.time-t.time!=0?e.value[s]=(e.time-t.time)*(n.value[s]-t.value[s])/(n.time-t.time)+t.value[s]:e.value[s]=t.value[s]}function E(t){const n=[],s=t.name,o=t.end-t.start||-1,i=t.animations;for(let e=0,t=i.length;e<t;e++){const t=y(i[e]);for(let e=0,s=t.length;e<s;e++)n.push(t[e])}return new e.AnimationClip(s,o,n)}function M(e){return m(Qe.clips[e],E)}function L(e){const t={sources:{}};for(let n=0,s=e.childNodes.length;n<s;n++){const s=e.childNodes[n];if(1===s.nodeType)switch(s.nodeName){case"bind_shape_matrix":t.bindShapeMatrix=r(s.textContent);break;case"source":const e=s.getAttribute("id");t.sources[e]=ae(s);break;case"joints":t.joints=R(s);break;case"vertex_weights":t.vertexWeights=O(s)}}return t}function R(e){const t={inputs:{}};for(let n=0,s=e.childNodes.length;n<s;n++){const s=e.childNodes[n];if(1===s.nodeType)switch(s.nodeName){case"input":const e=s.getAttribute("semantic"),n=c(s.getAttribute("source"));t.inputs[e]=n}}return t}function O(e){const t={inputs:{}};for(let n=0,s=e.childNodes.length;n<s;n++){const s=e.childNodes[n];if(1===s.nodeType)switch(s.nodeName){case"input":const e=s.getAttribute("semantic"),n=c(s.getAttribute("source")),o=parseInt(s.getAttribute("offset"));t.inputs[e]={id:n,offset:o};break;case"vcount":t.vcount=a(s.textContent);break;case"v":t.v=a(s.textContent)}}return t}function j(t){const n={id:t.id},s=Qe.geometries[n.id];return void 0!==t.skin&&(n.skin=function(t){const n=4,s={joints:[],indices:{array:[],stride:n},weights:{array:[],stride:n}},o=t.sources,i=t.vertexWeights,r=i.vcount,a=i.v,c=i.inputs.JOINT.offset,l=i.inputs.WEIGHT.offset,d=t.sources[t.joints.inputs.JOINT],u=t.sources[t.joints.inputs.INV_BIND_MATRIX],f=o[i.inputs.WEIGHT.id].array;let h,m,p,g=0;for(h=0,p=r.length;h<p;h++){const e=r[h],t=[];for(m=0;m<e;m++){const e=a[g+c],n=f[a[g+l]];t.push({index:e,weight:n}),g+=2}for(t.sort(b),m=0;m<n;m++){const e=t[m];void 0!==e?(s.indices.array.push(e.index),s.weights.array.push(e.weight)):(s.indices.array.push(0),s.weights.array.push(0))}}t.bindShapeMatrix?s.bindMatrix=(new e.Matrix4).fromArray(t.bindShapeMatrix).transpose():s.bindMatrix=(new e.Matrix4).identity();for(h=0,p=d.array.length;h<p;h++){const t=d.array[h],n=(new e.Matrix4).fromArray(u.array,h*u.stride).transpose();s.joints.push({name:t,boneInverse:n})}return s;function b(e,t){return t.weight-e.weight}}(t.skin),s.sources.skinIndices=n.skin.indices,s.sources.skinWeights=n.skin.weights),n}function q(e){return void 0!==e.build?e.build:e.init_from}function I(e){const t=Qe.images[e];return void 0!==t?m(t,q):(console.warn("THREE.ColladaLoader: Couldn't find image with ID:",e),null)}function S(e){const t={surfaces:{},samplers:{}};for(let n=0,s=e.childNodes.length;n<s;n++){const s=e.childNodes[n];if(1===s.nodeType)switch(s.nodeName){case"newparam":U(s,t);break;case"technique":t.technique=B(s);break;case"extra":t.extra=G(s)}}return t}function U(e,t){const n=e.getAttribute("sid");for(let s=0,o=e.childNodes.length;s<o;s++){const o=e.childNodes[s];if(1===o.nodeType)switch(o.nodeName){case"surface":t.surfaces[n]=F(o);break;case"sampler2D":t.samplers[n]=H(o)}}}function F(e){const t={};for(let n=0,s=e.childNodes.length;n<s;n++){const s=e.childNodes[n];if(1===s.nodeType)switch(s.nodeName){case"init_from":t.init_from=s.textContent}}return t}function H(e){const t={};for(let n=0,s=e.childNodes.length;n<s;n++){const s=e.childNodes[n];if(1===s.nodeType)switch(s.nodeName){case"source":t.source=s.textContent}}return t}function B(e){const t={};for(let n=0,s=e.childNodes.length;n<s;n++){const s=e.childNodes[n];if(1===s.nodeType)switch(s.nodeName){case"constant":case"lambert":case"blinn":case"phong":t.type=s.nodeName,t.parameters=V(s);break;case"extra":t.extra=G(s)}}return t}function V(e){const t={};for(let n=0,s=e.childNodes.length;n<s;n++){const s=e.childNodes[n];if(1===s.nodeType)switch(s.nodeName){case"emission":case"diffuse":case"specular":case"bump":case"ambient":case"shininess":case"transparency":t[s.nodeName]=P(s);break;case"transparent":t[s.nodeName]={opaque:s.hasAttribute("opaque")?s.getAttribute("opaque"):"A_ONE",data:P(s)}}}return t}function P(e){const t={};for(let n=0,s=e.childNodes.length;n<s;n++){const s=e.childNodes[n];if(1===s.nodeType)switch(s.nodeName){case"color":t[s.nodeName]=r(s.textContent);break;case"float":t[s.nodeName]=parseFloat(s.textContent);break;case"texture":t[s.nodeName]={id:s.getAttribute("texture"),extra:D(s)}}}return t}function D(e){const t={technique:{}};for(let n=0,s=e.childNodes.length;n<s;n++){const s=e.childNodes[n];if(1===s.nodeType)switch(s.nodeName){case"extra":W(s,t)}}return t}function W(e,t){for(let n=0,s=e.childNodes.length;n<s;n++){const s=e.childNodes[n];if(1===s.nodeType)switch(s.nodeName){case"technique":z(s,t)}}}function z(e,t){for(let n=0,s=e.childNodes.length;n<s;n++){const s=e.childNodes[n];if(1===s.nodeType)switch(s.nodeName){case"repeatU":case"repeatV":case"offsetU":case"offsetV":t.technique[s.nodeName]=parseFloat(s.textContent);break;case"wrapU":case"wrapV":"TRUE"===s.textContent.toUpperCase()?t.technique[s.nodeName]=1:"FALSE"===s.textContent.toUpperCase()?t.technique[s.nodeName]=0:t.technique[s.nodeName]=parseInt(s.textContent);break;case"bump":t[s.nodeName]=X(s)}}}function G(e){const t={};for(let n=0,s=e.childNodes.length;n<s;n++){const s=e.childNodes[n];if(1===s.nodeType)switch(s.nodeName){case"technique":t.technique=J(s)}}return t}function J(e){const t={};for(let n=0,s=e.childNodes.length;n<s;n++){const s=e.childNodes[n];if(1===s.nodeType)switch(s.nodeName){case"double_sided":t[s.nodeName]=parseInt(s.textContent);break;case"bump":t[s.nodeName]=X(s)}}return t}function X(e){for(var t={},n=0,s=e.childNodes.length;n<s;n++){var o=e.childNodes[n];if(1===o.nodeType)switch(o.nodeName){case"texture":t[o.nodeName]={id:o.getAttribute("texture"),texcoord:o.getAttribute("texcoord"),extra:D(o)}}}return t}function K(e){return e}function Z(t){const n=(s=t.url,m(Qe.effects[s],K));var s;const o=n.profile.technique;let i;switch(o.type){case"phong":case"blinn":i=new e.MeshPhongMaterial;break;case"lambert":i=new e.MeshLambertMaterial;break;default:i=new e.MeshBasicMaterial}function r(t){const s=n.profile.samplers[t.id];let o=null;if(void 0!==s){o=I(n.profile.surfaces[s.source].init_from)}else console.warn("THREE.ColladaLoader: Undefined sampler. Access image directly (see #12530)."),o=I(t.id);if(null!==o){const n=function(e){let t,n=e.slice(2+(e.lastIndexOf(".")-1>>>0));switch(n=n.toLowerCase(),n){case"tga":t=Je;break;default:t=Ge}return t}(o);if(void 0!==n){const s=n.load(o),i=t.extra;if(void 0!==i&&void 0!==i.technique&&!1===l(i.technique)){const t=i.technique;s.wrapS=t.wrapU?e.RepeatWrapping:e.ClampToEdgeWrapping,s.wrapT=t.wrapV?e.RepeatWrapping:e.ClampToEdgeWrapping,s.offset.set(t.offsetU||0,t.offsetV||0),s.repeat.set(t.repeatU||1,t.repeatV||1)}else s.wrapS=e.RepeatWrapping,s.wrapT=e.RepeatWrapping;return s}return console.warn("THREE.ColladaLoader: Loader for texture %s not found.",o),null}return console.warn("THREE.ColladaLoader: Couldn't create texture with ID:",t.id),null}i.name=t.name||"";const a=o.parameters;for(const e in a){const t=a[e];switch(e){case"diffuse":t.color&&i.color.fromArray(t.color),t.texture&&(i.map=r(t.texture));break;case"specular":t.color&&i.specular&&i.specular.fromArray(t.color),t.texture&&(i.specularMap=r(t.texture));break;case"bump":t.texture&&(i.normalMap=r(t.texture));break;case"ambient":t.texture&&(i.lightMap=r(t.texture));break;case"shininess":t.float&&i.shininess&&(i.shininess=t.float);break;case"emission":t.color&&i.emissive&&i.emissive.fromArray(t.color),t.texture&&(i.emissiveMap=r(t.texture))}}let c=a.transparent,d=a.transparency;if(void 0===d&&c&&(d={float:1}),void 0===c&&d&&(c={opaque:"A_ONE",data:{color:[1,1,1,1]}}),c&&d)if(c.data.texture)i.transparent=!0;else{const e=c.data.color;switch(c.opaque){case"A_ONE":i.opacity=e[3]*d.float;break;case"RGB_ZERO":i.opacity=1-e[0]*d.float;break;case"A_ZERO":i.opacity=1-e[3]*d.float;break;case"RGB_ONE":i.opacity=e[0]*d.float;break;default:console.warn('THREE.ColladaLoader: Invalid opaque type "%s" of transparent tag.',c.opaque)}i.opacity<1&&(i.transparent=!0)}if(void 0!==o.extra&&void 0!==o.extra.technique){const t=o.extra.technique;for(const n in t){const s=t[n];switch(n){case"double_sided":i.side=1===s?e.DoubleSide:e.FrontSide;break;case"bump":i.normalMap=r(s.texture),i.normalScale=new e.Vector2(1,1)}}}return i}function Q(e){return m(Qe.materials[e],Z)}function Y(e){for(let t=0;t<e.childNodes.length;t++){const n=e.childNodes[t];switch(n.nodeName){case"technique_common":return $(n)}}return{}}function $(e){const t={};for(let n=0;n<e.childNodes.length;n++){const s=e.childNodes[n];switch(s.nodeName){case"perspective":case"orthographic":t.technique=s.nodeName,t.parameters=ee(s)}}return t}function ee(e){const t={};for(let n=0;n<e.childNodes.length;n++){const s=e.childNodes[n];switch(s.nodeName){case"xfov":case"yfov":case"xmag":case"ymag":case"znear":case"zfar":case"aspect_ratio":t[s.nodeName]=parseFloat(s.textContent)}}return t}function te(t){let n;switch(t.optics.technique){case"perspective":n=new e.PerspectiveCamera(t.optics.parameters.yfov,t.optics.parameters.aspect_ratio,t.optics.parameters.znear,t.optics.parameters.zfar);break;case"orthographic":let s=t.optics.parameters.ymag,o=t.optics.parameters.xmag;const i=t.optics.parameters.aspect_ratio;o=void 0===o?s*i:o,s=void 0===s?o/i:s,o*=.5,s*=.5,n=new e.OrthographicCamera(-o,o,s,-s,t.optics.parameters.znear,t.optics.parameters.zfar);break;default:n=new e.PerspectiveCamera}return n.name=t.name||"",n}function ne(e){const t=Qe.cameras[e];return void 0!==t?m(t,te):(console.warn("THREE.ColladaLoader: Couldn't find camera with ID:",e),null)}function se(e){const t={};for(let n=0,s=e.childNodes.length;n<s;n++){const s=e.childNodes[n];if(1===s.nodeType)switch(s.nodeName){case"directional":case"point":case"spot":case"ambient":t.technique=s.nodeName,t.parameters=oe(s)}}return t}function oe(t){const n={};for(let s=0,o=t.childNodes.length;s<o;s++){const o=t.childNodes[s];if(1===o.nodeType)switch(o.nodeName){case"color":const t=r(o.textContent);n.color=(new e.Color).fromArray(t);break;case"falloff_angle":n.falloffAngle=parseFloat(o.textContent);break;case"quadratic_attenuation":const s=parseFloat(o.textContent);n.distance=s?Math.sqrt(1/s):0}}return n}function ie(t){let n;switch(t.technique){case"directional":n=new e.DirectionalLight;break;case"point":n=new e.PointLight;break;case"spot":n=new e.SpotLight;break;case"ambient":n=new e.AmbientLight}return t.parameters.color&&n.color.copy(t.parameters.color),t.parameters.distance&&(n.distance=t.parameters.distance),n}function re(e){const t=Qe.lights[e];return void 0!==t?m(t,ie):(console.warn("THREE.ColladaLoader: Couldn't find light with ID:",e),null)}function ae(e){const t={array:[],stride:3};for(let n=0;n<e.childNodes.length;n++){const s=e.childNodes[n];if(1===s.nodeType)switch(s.nodeName){case"float_array":t.array=r(s.textContent);break;case"Name_array":t.array=i(s.textContent);break;case"technique_common":const e=o(s,"accessor")[0];void 0!==e&&(t.stride=parseInt(e.getAttribute("stride")))}}return t}function ce(e){const t={};for(let n=0;n<e.childNodes.length;n++){const s=e.childNodes[n];1===s.nodeType&&(t[s.getAttribute("semantic")]=c(s.getAttribute("source")))}return t}function le(e){const t={type:e.nodeName,material:e.getAttribute("material"),count:parseInt(e.getAttribute("count")),inputs:{},stride:0,hasUV:!1};for(let n=0,s=e.childNodes.length;n<s;n++){const s=e.childNodes[n];if(1===s.nodeType)switch(s.nodeName){case"input":const e=c(s.getAttribute("source")),n=s.getAttribute("semantic"),o=parseInt(s.getAttribute("offset")),i=parseInt(s.getAttribute("set")),r=i>0?n+i:n;t.inputs[r]={id:e,offset:o},t.stride=Math.max(t.stride,o+1),"TEXCOORD"===n&&(t.hasUV=!0);break;case"vcount":t.vcount=a(s.textContent);break;case"p":t.p=a(s.textContent)}}return t}function de(e){let t=0;for(let n=0,s=e.length;n<s;n++){!0===e[n].hasUV&&t++}t>0&&t<e.length&&(e.uvsNeedsFix=!0)}function ue(e){const t={},n=e.sources,s=e.vertices,o=e.primitives;if(0===o.length)return{};const i=function(e){const t={};for(let n=0;n<e.length;n++){const s=e[n];void 0===t[s.type]&&(t[s.type]=[]),t[s.type].push(s)}return t}(o);for(const e in i){const o=i[e];de(o),t[e]=fe(o,n,s)}return t}function fe(t,n,s){const o={},i={array:[],stride:0},r={array:[],stride:0},a={array:[],stride:0},c={array:[],stride:0},l={array:[],stride:0},d=[],u=4,f=[],h=4,m=new e.BufferGeometry,p=[];let g=0;for(let e=0;e<t.length;e++){const o=t[e],u=o.inputs;let h=0;switch(o.type){case"lines":case"linestrips":h=2*o.count;break;case"triangles":h=3*o.count;break;case"polylist":for(let e=0;e<o.count;e++){const t=o.vcount[e];switch(t){case 3:h+=3;break;case 4:h+=6;break;default:h+=3*(t-2)}}break;default:console.warn("THREE.ColladaLoader: Unknow primitive type:",o.type)}m.addGroup(g,h,e),g+=h,o.material&&p.push(o.material);for(const e in u){const h=u[e];switch(e){case"VERTEX":for(const e in s){const u=s[e];switch(e){case"POSITION":const s=i.array.length;if(he(o,n[u],h.offset,i.array),i.stride=n[u].stride,n.skinWeights&&n.skinIndices&&(he(o,n.skinIndices,h.offset,d),he(o,n.skinWeights,h.offset,f)),!1===o.hasUV&&!0===t.uvsNeedsFix){const e=(i.array.length-s)/i.stride;for(let t=0;t<e;t++)a.array.push(0,0)}break;case"NORMAL":he(o,n[u],h.offset,r.array),r.stride=n[u].stride;break;case"COLOR":he(o,n[u],h.offset,l.array),l.stride=n[u].stride;break;case"TEXCOORD":he(o,n[u],h.offset,a.array),a.stride=n[u].stride;break;case"TEXCOORD1":he(o,n[u],h.offset,c.array),a.stride=n[u].stride;break;default:console.warn('THREE.ColladaLoader: Semantic "%s" not handled in geometry build process.',e)}}break;case"NORMAL":he(o,n[h.id],h.offset,r.array),r.stride=n[h.id].stride;break;case"COLOR":he(o,n[h.id],h.offset,l.array),l.stride=n[h.id].stride;break;case"TEXCOORD":he(o,n[h.id],h.offset,a.array),a.stride=n[h.id].stride;break;case"TEXCOORD1":he(o,n[h.id],h.offset,c.array),c.stride=n[h.id].stride}}}return i.array.length>0&&m.setAttribute("position",new e.Float32BufferAttribute(i.array,i.stride)),r.array.length>0&&m.setAttribute("normal",new e.Float32BufferAttribute(r.array,r.stride)),l.array.length>0&&m.setAttribute("color",new e.Float32BufferAttribute(l.array,l.stride)),a.array.length>0&&m.setAttribute("uv",new e.Float32BufferAttribute(a.array,a.stride)),c.array.length>0&&m.setAttribute("uv2",new e.Float32BufferAttribute(c.array,c.stride)),d.length>0&&m.setAttribute("skinIndex",new e.Float32BufferAttribute(d,u)),f.length>0&&m.setAttribute("skinWeight",new e.Float32BufferAttribute(f,h)),o.data=m,o.type=t[0].type,o.materialKeys=p,o}function he(e,t,n,s){const o=e.p,i=e.stride,r=e.vcount;function a(e){let t=o[e+n]*l;const i=t+l;for(;t<i;t++)s.push(c[t])}const c=t.array,l=t.stride;if(void 0!==e.vcount){let e=0;for(let t=0,n=r.length;t<n;t++){const n=r[t];if(4===n){const t=e+1*i,n=e+2*i,s=e+3*i;a(e+0*i),a(t),a(s),a(t),a(n),a(s)}else if(3===n){const t=e+1*i,n=e+2*i;a(e+0*i),a(t),a(n)}else if(n>4)for(let t=1,s=n-2;t<=s;t++){const n=e+i*t,s=e+i*(t+1);a(e+0*i),a(n),a(s)}e+=i*n}}else for(let e=0,t=o.length;e<t;e+=i)a(e)}function me(e){return m(Qe.geometries[e],ue)}function pe(e){return void 0!==e.build?e.build:e}function ge(e,t){for(let n=0;n<e.childNodes.length;n++){const s=e.childNodes[n];if(1===s.nodeType)switch(s.nodeName){case"joint":t.joints[s.getAttribute("sid")]=be(s);break;case"link":t.links.push(Ne(s))}}}function be(e){let t;for(let n=0;n<e.childNodes.length;n++){const s=e.childNodes[n];if(1===s.nodeType)switch(s.nodeName){case"prismatic":case"revolute":t=ye(s)}}return t}function ye(t){const n={sid:t.getAttribute("sid"),name:t.getAttribute("name")||"",axis:new e.Vector3,limits:{min:0,max:0},type:t.nodeName,static:!1,zeroPosition:0,middlePosition:0};for(let e=0;e<t.childNodes.length;e++){const s=t.childNodes[e];if(1===s.nodeType)switch(s.nodeName){case"axis":const e=r(s.textContent);n.axis.fromArray(e);break;case"limits":const t=s.getElementsByTagName("max")[0],o=s.getElementsByTagName("min")[0];n.limits.max=parseFloat(t.textContent),n.limits.min=parseFloat(o.textContent)}}return n.limits.min>=n.limits.max&&(n.static=!0),n.middlePosition=(n.limits.min+n.limits.max)/2,n}function Ne(e){const t={sid:e.getAttribute("sid"),name:e.getAttribute("name")||"",attachments:[],transforms:[]};for(let n=0;n<e.childNodes.length;n++){const s=e.childNodes[n];if(1===s.nodeType)switch(s.nodeName){case"attachment_full":t.attachments.push(we(s));break;case"matrix":case"translate":case"rotate":t.transforms.push(xe(s))}}return t}function we(e){const t={joint:e.getAttribute("joint").split("/").pop(),transforms:[],links:[]};for(let n=0;n<e.childNodes.length;n++){const s=e.childNodes[n];if(1===s.nodeType)switch(s.nodeName){case"link":t.links.push(Ne(s));break;case"matrix":case"translate":case"rotate":t.transforms.push(xe(s))}}return t}function xe(t){const n={type:t.nodeName},s=r(t.textContent);switch(n.type){case"matrix":n.obj=new e.Matrix4,n.obj.fromArray(s).transpose();break;case"translate":n.obj=new e.Vector3,n.obj.fromArray(s);break;case"rotate":n.obj=new e.Vector3,n.obj.fromArray(s),n.angle=e.MathUtils.degToRad(s[3])}return n}function ke(e,t){for(let n=0;n<e.childNodes.length;n++){const s=e.childNodes[n];if(1===s.nodeType)switch(s.nodeName){case"technique_common":Ae(s,t)}}}function Ae(e,t){for(let n=0;n<e.childNodes.length;n++){const s=e.childNodes[n];if(1===s.nodeType)switch(s.nodeName){case"inertia":t.inertia=r(s.textContent);break;case"mass":t.mass=r(s.textContent)[0]}}}function ve(e){const t={target:e.getAttribute("target").split("/").pop()};for(let n=0;n<e.childNodes.length;n++){const s=e.childNodes[n];if(1===s.nodeType)switch(s.nodeName){case"axis":const e=s.getElementsByTagName("param")[0];t.axis=e.textContent;const n=t.axis.split("inst_").pop().split("axis")[0];t.jointIndex=n.substr(0,n.length-1)}}return t}function Te(e){return void 0!==e.build?e.build:e}function Ce(t){const n=[],s=Pe.querySelector('[id="'+t.id+'"]');for(let t=0;t<s.childNodes.length;t++){const o=s.childNodes[t];if(1!==o.nodeType)continue;let i,a;switch(o.nodeName){case"matrix":i=r(o.textContent);const t=(new e.Matrix4).fromArray(i).transpose();n.push({sid:o.getAttribute("sid"),type:o.nodeName,obj:t});break;case"translate":case"scale":i=r(o.textContent),a=(new e.Vector3).fromArray(i),n.push({sid:o.getAttribute("sid"),type:o.nodeName,obj:a});break;case"rotate":i=r(o.textContent),a=(new e.Vector3).fromArray(i);const s=e.MathUtils.degToRad(i[3]);n.push({sid:o.getAttribute("sid"),type:o.nodeName,obj:a,angle:s})}}return n}const _e=new e.Matrix4,Ee=new e.Vector3;function Me(t){const n={name:t.getAttribute("name")||"",type:t.getAttribute("type"),id:t.getAttribute("id"),sid:t.getAttribute("sid"),matrix:new e.Matrix4,nodes:[],instanceCameras:[],instanceControllers:[],instanceLights:[],instanceGeometries:[],instanceNodes:[],transforms:{}};for(let s=0;s<t.childNodes.length;s++){const o=t.childNodes[s];if(1!==o.nodeType)continue;let i;switch(o.nodeName){case"node":n.nodes.push(o.getAttribute("id")),Me(o);break;case"instance_camera":n.instanceCameras.push(c(o.getAttribute("url")));break;case"instance_controller":n.instanceControllers.push(Le(o));break;case"instance_light":n.instanceLights.push(c(o.getAttribute("url")));break;case"instance_geometry":n.instanceGeometries.push(Le(o));break;case"instance_node":n.instanceNodes.push(c(o.getAttribute("url")));break;case"matrix":i=r(o.textContent),n.matrix.multiply(_e.fromArray(i).transpose()),n.transforms[o.getAttribute("sid")]=o.nodeName;break;case"translate":i=r(o.textContent),Ee.fromArray(i),n.matrix.multiply(_e.makeTranslation(Ee.x,Ee.y,Ee.z)),n.transforms[o.getAttribute("sid")]=o.nodeName;break;case"rotate":i=r(o.textContent);const t=e.MathUtils.degToRad(i[3]);n.matrix.multiply(_e.makeRotationAxis(Ee.fromArray(i),t)),n.transforms[o.getAttribute("sid")]=o.nodeName;break;case"scale":i=r(o.textContent),n.matrix.scale(Ee.fromArray(i)),n.transforms[o.getAttribute("sid")]=o.nodeName;break;case"extra":break;default:console.log(o)}}return Ue(n.id)?console.warn("THREE.ColladaLoader: There is already a node with ID %s. Exclude current node from further processing.",n.id):Qe.nodes[n.id]=n,n}function Le(e){const t={id:c(e.getAttribute("url")),materials:{},skeletons:[]};for(let n=0;n<e.childNodes.length;n++){const s=e.childNodes[n];switch(s.nodeName){case"bind_material":const e=s.getElementsByTagName("instance_material");for(let n=0;n<e.length;n++){const s=e[n],o=s.getAttribute("symbol"),i=s.getAttribute("target");t.materials[o]=c(i)}break;case"skeleton":t.skeletons.push(c(s.textContent))}}return t}function Re(t,n){const s=[],o=[];let i,r,a;for(i=0;i<t.length;i++){const e=t[i];let o;if(Ue(e))o=Fe(e),Oe(o,n,s);else if(c=e,void 0!==Qe.visualScenes[c]){const t=Qe.visualScenes[e].children;for(let e=0;e<t.length;e++){const o=t[e];if("JOINT"===o.type){Oe(Fe(o.id),n,s)}}}else console.error("THREE.ColladaLoader: Unable to find root bone of skeleton with ID:",e)}var c;for(i=0;i<n.length;i++)for(r=0;r<s.length;r++)if(a=s[r],a.bone.name===n[i].name){o[i]=a,a.processed=!0;break}for(i=0;i<s.length;i++)a=s[i],!1===a.processed&&(o.push(a),a.processed=!0);const l=[],d=[];for(i=0;i<o.length;i++)a=o[i],l.push(a.bone),d.push(a.boneInverse);return new e.Skeleton(l,d)}function Oe(t,n,s){t.traverse((function(t){if(!0===t.isBone){let o;for(let e=0;e<n.length;e++){const s=n[e];if(s.name===t.name){o=s.boneInverse;break}}void 0===o&&(o=new e.Matrix4),s.push({bone:t,boneInverse:o,processed:!1})}}))}function je(t){const n=[],s=t.matrix,o=t.nodes,i=t.type,r=t.instanceCameras,a=t.instanceControllers,c=t.instanceLights,l=t.instanceGeometries,d=t.instanceNodes;for(let e=0,t=o.length;e<t;e++)n.push(Fe(o[e]));for(let e=0,t=r.length;e<t;e++){const t=ne(r[e]);null!==t&&n.push(t.clone())}for(let e=0,t=a.length;e<t;e++){const t=a[e],s=(u=t.id,m(Qe.controllers[u],j)),o=Se(me(s.id),t.materials),i=Re(t.skeletons,s.skin.joints);for(let e=0,t=o.length;e<t;e++){const t=o[e];t.isSkinnedMesh&&(t.bind(i,s.skin.bindMatrix),t.normalizeSkinWeights()),n.push(t)}}var u;for(let e=0,t=c.length;e<t;e++){const t=re(c[e]);null!==t&&n.push(t.clone())}for(let e=0,t=l.length;e<t;e++){const t=l[e],s=Se(me(t.id),t.materials);for(let e=0,t=s.length;e<t;e++)n.push(s[e])}for(let e=0,t=d.length;e<t;e++)n.push(Fe(d[e]).clone());let f;if(0===o.length&&1===n.length)f=n[0];else{f="JOINT"===i?new e.Bone:new e.Group;for(let e=0;e<n.length;e++)f.add(n[e])}return f.name="JOINT"===i?t.sid:t.name,f.matrix.copy(s),f.matrix.decompose(f.position,f.quaternion,f.scale),f}const qe=new e.MeshBasicMaterial({color:16711935});function Ie(e,t){const n=[];for(let s=0,o=e.length;s<o;s++){const o=t[e[s]];void 0===o?(console.warn("THREE.ColladaLoader: Material with key %s not found. Apply fallback material.",e[s]),n.push(qe)):n.push(Q(o))}return n}function Se(t,n){const s=[];for(const o in t){const i=t[o],r=Ie(i.materialKeys,n);0===r.length&&("lines"===o||"linestrips"===o?r.push(new e.LineBasicMaterial):r.push(new e.MeshPhongMaterial));const a=void 0!==i.data.attributes.skinIndex,c=1===r.length?r[0]:r;let l;switch(o){case"lines":l=new e.LineSegments(i.data,c);break;case"linestrips":l=new e.Line(i.data,c);break;case"triangles":case"polylist":l=a?new e.SkinnedMesh(i.data,c):new e.Mesh(i.data,c)}s.push(l)}return s}function Ue(e){return void 0!==Qe.nodes[e]}function Fe(e){return m(Qe.nodes[e],je)}function He(t){const n=new e.Group;n.name=t.name;const s=t.children;for(let e=0;e<s.length;e++){const t=s[e];n.add(Fe(t.id))}return n}function Be(e){return m(Qe.visualScenes[e],He)}if(0===n.length)return{scene:new e.Scene};const Ve=(new DOMParser).parseFromString(n,"application/xml"),Pe=o(Ve,"COLLADA")[0],De=Ve.getElementsByTagName("parsererror")[0];if(void 0!==De){const e=o(De,"div")[0];let t;return t=e?e.textContent:function(e){let t="";const n=[e];for(;n.length;){const e=n.shift();e.nodeType===Node.TEXT_NODE?t+=e.textContent:(t+="\n",n.push.apply(n,e.childNodes))}return t.trim()}(De),console.error("THREE.ColladaLoader: Failed to parse collada file.\n",t),null}const We=Pe.getAttribute("version");console.log("THREE.ColladaLoader: File version",We);const ze=function(e){return{unit:d(o(e,"unit")[0]),upAxis:u(o(e,"up_axis")[0])}}(o(Pe,"asset")[0]),Ge=new e.TextureLoader(this.manager);let Je;Ge.setPath(this.resourcePath||s).setCrossOrigin(this.crossOrigin),t.TGALoader&&(Je=new t.TGALoader(this.manager),Je.setPath(this.resourcePath||s));const Xe=[];let Ke={},Ze=0;const Qe={animations:{},clips:{},controllers:{},images:{},effects:{},materials:{},cameras:{},lights:{},geometries:{},nodes:{},visualScenes:{},kinematicsModels:{},physicsModels:{},kinematicsScenes:{}};f(Pe,"library_animations","animation",(function t(n){const s={sources:{},samplers:{},channels:{}};let o=!1;for(let e=0,i=n.childNodes.length;e<i;e++){const i=n.childNodes[e];if(1!==i.nodeType)continue;let r;switch(i.nodeName){case"source":r=i.getAttribute("id"),s.sources[r]=ae(i);break;case"sampler":r=i.getAttribute("id"),s.samplers[r]=p(i);break;case"channel":r=i.getAttribute("target"),s.channels[r]=g(i);break;case"animation":t(i),o=!0;break;default:console.log(i)}}!1===o&&(Qe.animations[n.getAttribute("id")||e.MathUtils.generateUUID()]=s)})),f(Pe,"library_animation_clips","animation_clip",(function(e){const t={name:e.getAttribute("id")||"default",start:parseFloat(e.getAttribute("start")||0),end:parseFloat(e.getAttribute("end")||0),animations:[]};for(let n=0,s=e.childNodes.length;n<s;n++){const s=e.childNodes[n];if(1===s.nodeType)switch(s.nodeName){case"instance_animation":t.animations.push(c(s.getAttribute("url")))}}Qe.clips[e.getAttribute("id")]=t})),f(Pe,"library_controllers","controller",(function(e){const t={};for(let n=0,s=e.childNodes.length;n<s;n++){const s=e.childNodes[n];if(1===s.nodeType)switch(s.nodeName){case"skin":t.id=c(s.getAttribute("source")),t.skin=L(s);break;case"morph":t.id=c(s.getAttribute("source")),console.warn("THREE.ColladaLoader: Morph target animation not supported yet.")}}Qe.controllers[e.getAttribute("id")]=t})),f(Pe,"library_images","image",(function(e){const t={init_from:o(e,"init_from")[0].textContent};Qe.images[e.getAttribute("id")]=t})),f(Pe,"library_effects","effect",(function(e){const t={};for(let n=0,s=e.childNodes.length;n<s;n++){const s=e.childNodes[n];if(1===s.nodeType)switch(s.nodeName){case"profile_COMMON":t.profile=S(s)}}Qe.effects[e.getAttribute("id")]=t})),f(Pe,"library_materials","material",(function(e){const t={name:e.getAttribute("name")};for(let n=0,s=e.childNodes.length;n<s;n++){const s=e.childNodes[n];if(1===s.nodeType)switch(s.nodeName){case"instance_effect":t.url=c(s.getAttribute("url"))}}Qe.materials[e.getAttribute("id")]=t})),f(Pe,"library_cameras","camera",(function(e){const t={name:e.getAttribute("name")};for(let n=0,s=e.childNodes.length;n<s;n++){const s=e.childNodes[n];if(1===s.nodeType)switch(s.nodeName){case"optics":t.optics=Y(s)}}Qe.cameras[e.getAttribute("id")]=t})),f(Pe,"library_lights","light",(function(e){let t={};for(let n=0,s=e.childNodes.length;n<s;n++){const s=e.childNodes[n];if(1===s.nodeType)switch(s.nodeName){case"technique_common":t=se(s)}}Qe.lights[e.getAttribute("id")]=t})),f(Pe,"library_geometries","geometry",(function(e){const t={name:e.getAttribute("name"),sources:{},vertices:{},primitives:[]},n=o(e,"mesh")[0];if(void 0!==n){for(let e=0;e<n.childNodes.length;e++){const s=n.childNodes[e];if(1!==s.nodeType)continue;const o=s.getAttribute("id");switch(s.nodeName){case"source":t.sources[o]=ae(s);break;case"vertices":t.vertices=ce(s);break;case"polygons":console.warn("THREE.ColladaLoader: Unsupported primitive type: ",s.nodeName);break;case"lines":case"linestrips":case"polylist":case"triangles":t.primitives.push(le(s));break;default:console.log(s)}}Qe.geometries[e.getAttribute("id")]=t}})),f(Pe,"library_nodes","node",Me),f(Pe,"library_visual_scenes","visual_scene",(function(e){const t={name:e.getAttribute("name"),children:[]};!function(e){const t=e.getElementsByTagName("node");for(let e=0;e<t.length;e++){const n=t[e];!1===n.hasAttribute("id")&&n.setAttribute("id","three_default_"+Ze++)}}(e);const n=o(e,"node");for(let e=0;e<n.length;e++)t.children.push(Me(n[e]));Qe.visualScenes[e.getAttribute("id")]=t})),f(Pe,"library_kinematics_models","kinematics_model",(function(e){const t={name:e.getAttribute("name")||"",joints:{},links:[]};for(let n=0;n<e.childNodes.length;n++){const s=e.childNodes[n];if(1===s.nodeType)switch(s.nodeName){case"technique_common":ge(s,t)}}Qe.kinematicsModels[e.getAttribute("id")]=t})),f(Pe,"library_physics_models","physics_model",(function(e){const t={name:e.getAttribute("name")||"",rigidBodies:{}};for(let n=0;n<e.childNodes.length;n++){const s=e.childNodes[n];if(1===s.nodeType)switch(s.nodeName){case"rigid_body":t.rigidBodies[s.getAttribute("name")]={},ke(s,t.rigidBodies[s.getAttribute("name")])}}Qe.physicsModels[e.getAttribute("id")]=t})),f(Pe,"scene","instance_kinematics_scene",(function(e){const t={bindJointAxis:[]};for(let n=0;n<e.childNodes.length;n++){const s=e.childNodes[n];if(1===s.nodeType)switch(s.nodeName){case"bind_joint_axis":t.bindJointAxis.push(ve(s))}}Qe.kinematicsScenes[c(e.getAttribute("url"))]=t})),h(Qe.animations,b),h(Qe.clips,E),h(Qe.controllers,j),h(Qe.images,q),h(Qe.effects,K),h(Qe.materials,Z),h(Qe.cameras,te),h(Qe.lights,ie),h(Qe.geometries,ue),h(Qe.visualScenes,He),function(){const t=Qe.clips;if(!0===l(t)){if(!1===l(Qe.animations)){const t=[];for(const e in Qe.animations){const n=y(e);for(let e=0,s=n.length;e<s;e++)t.push(n[e])}Xe.push(new e.AnimationClip("default",-1,t))}}else for(const e in t)Xe.push(M(e))}(),function(){const t=Object.keys(Qe.kinematicsModels)[0],n=Object.keys(Qe.kinematicsScenes)[0],s=Object.keys(Qe.visualScenes)[0];if(void 0===t||void 0===n)return;const o=(i=t,m(Qe.kinematicsModels[i],pe));var i;const r=function(e){return m(Qe.kinematicsScenes[e],Te)}(n),a=Be(s),c=r.bindJointAxis,l={};for(let e=0,t=c.length;e<t;e++){const t=c[e],n=Pe.querySelector('[sid="'+t.target+'"]');if(n){const e=n.parentElement;d(t.jointIndex,e)}}function d(e,t){const n=t.getAttribute("name"),s=o.joints[e];a.traverse((function(o){o.name===n&&(l[e]={object:o,transforms:Ce(t),joint:s,position:s.zeroPosition})}))}const u=new e.Matrix4;Ke={joints:o&&o.joints,getJointValue:function(e){const t=l[e];if(t)return t.position;console.warn("THREE.ColladaLoader: Joint "+e+" doesn't exist.")},setJointValue:function(t,n){const s=l[t];if(s){const o=s.joint;if(n>o.limits.max||n<o.limits.min)console.warn("THREE.ColladaLoader: Joint "+t+" value "+n+" outside of limits (min: "+o.limits.min+", max: "+o.limits.max+").");else if(o.static)console.warn("THREE.ColladaLoader: Joint "+t+" is static.");else{const i=s.object,r=o.axis,a=s.transforms;_e.identity();for(let s=0;s<a.length;s++){const i=a[s];if(i.sid&&-1!==i.sid.indexOf(t))switch(o.type){case"revolute":_e.multiply(u.makeRotationAxis(r,e.MathUtils.degToRad(n)));break;case"prismatic":_e.multiply(u.makeTranslation(r.x*n,r.y*n,r.z*n));break;default:console.warn("THREE.ColladaLoader: Unknown joint type: "+o.type)}else switch(i.type){case"matrix":_e.multiply(i.obj);break;case"translate":_e.multiply(u.makeTranslation(i.obj.x,i.obj.y,i.obj.z));break;case"scale":_e.scale(i.obj);break;case"rotate":_e.multiply(u.makeRotationAxis(i.obj,i.angle))}}i.matrix.copy(_e),i.matrix.decompose(i.position,i.quaternion,i.scale),l[t].position=n}}else console.log("THREE.ColladaLoader: "+t+" does not exist.")}}}();const Ye=function(e){return Be(c(o(e,"instance_visual_scene")[0].getAttribute("url")))}(o(Pe,"scene")[0]);return Ye.animations=Xe,"Z_UP"===ze.upAxis&&Ye.quaternion.setFromEuler(new e.Euler(-Math.PI/2,0,0)),Ye.scale.multiplyScalar(ze.unit),{get animations(){return console.warn("THREE.ColladaLoader: Please access animations over scene.animations now."),Xe},kinematics:Ke,library:Qe,scene:Ye}}}exports.ColladaLoader=n;
