"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("three"),t=require("./lwo/IFFParser.cjs.js");let a;require("./lwo/LWO2Parser.cjs.js"),require("./lwo/LWO3Parser.cjs.js");class s extends e.Loader{constructor(e,t={}){super(e),this.resourcePath=void 0!==t.resourcePath?t.resourcePath:""}load(t,a,s,r){const i=this,o=""===i.path?function(e,t){const a=e.indexOf(t);return-1===a?"./":e.substr(0,a)}(t,"Objects"):i.path,n=t.split(o).pop().split(".")[0],p=new e.FileLoader(this.manager);p.setPath(i.path),p.setResponseType("arraybuffer"),p.load(t,(function(e){try{a(i.parse(e,o,n))}catch(e){r?r(e):console.error(e),i.manager.itemError(t)}}),s,r)}parse(s,i,o){a=(new t.IFFParser).parse(s);const n=new e.TextureLoader(this.manager).setPath(this.resourcePath||i).setCrossOrigin(this.crossOrigin);return new r(n).parse(o)}}class r{constructor(e){this.textureLoader=e}parse(e){return this.materials=new i(this.textureLoader).parse(),this.defaultLayerName=e,this.meshes=this.parseLayers(),{materials:this.materials,meshes:this.meshes}}parseLayers(){const e=[],t=[],s=new o,r=this;return a.layers.forEach((function(a){const i=s.parse(a.geometry,a),o=r.parseMesh(i,a);e[a.number]=o,-1===a.parent?t.push(o):e[a.parent].add(o)})),this.applyPivots(t),t}parseMesh(t,a){let s;const r=this.getMaterials(t.userData.matNames,a.geometry.type);return this.duplicateUVs(t,r),s="points"===a.geometry.type?new e.Points(t,r):"lines"===a.geometry.type?new e.LineSegments(t,r):new e.Mesh(t,r),a.name?s.name=a.name:s.name=this.defaultLayerName+"_layer_"+a.number,s.userData.pivot=a.pivot,s}applyPivots(e){e.forEach((function(e){e.traverse((function(e){const t=e.userData.pivot;if(e.position.x+=t[0],e.position.y+=t[1],e.position.z+=t[2],e.parent){const t=e.parent.userData.pivot;e.position.x-=t[0],e.position.y-=t[1],e.position.z-=t[2]}}))}))}getMaterials(t,a){const s=[],r=this;t.forEach((function(e,t){s[t]=r.getMaterialByName(e)})),"points"!==a&&"lines"!==a||s.forEach((function(t,r){const i={color:t.color};"points"===a?(i.size=.1,i.map=t.map,i.morphTargets=t.morphTargets,s[r]=new e.PointsMaterial(i)):"lines"===a&&(s[r]=new e.LineBasicMaterial(i))}));const i=s.filter(Boolean);return 1===i.length?i[0]:s}getMaterialByName(e){return this.materials.filter((function(t){return t.name===e}))[0]}duplicateUVs(t,a){let s=!1;Array.isArray(a)?a.forEach((function(e){e.aoMap&&(s=!0)})):a.aoMap&&(s=!0),s&&t.setAttribute("uv2",new e.BufferAttribute(t.attributes.uv.array,2))}}class i{constructor(e){this.textureLoader=e}parse(){const e=[];this.textures={};for(const t in a.materials)"LWO3"===a.format?e.push(this.parseMaterial(a.materials[t],t,a.textures)):"LWO2"===a.format&&e.push(this.parseMaterialLwo2(a.materials[t],t,a.textures));return e}parseMaterial(e,t,a){let s={name:t,side:this.getSide(e.attributes),flatShading:this.getSmooth(e.attributes)};const r=this.parseConnections(e.connections,e.nodes),i=this.parseTextureNodes(r.maps);this.parseAttributeImageMaps(r.attributes,a,i,e.maps);const o=this.parseAttributes(r.attributes,i);this.parseEnvMap(r,i,o),s=Object.assign(i,s),s=Object.assign(s,o);return new(this.getMaterialType(r.attributes))(s)}parseMaterialLwo2(t,a){let s={name:a,side:this.getSide(t.attributes),flatShading:this.getSmooth(t.attributes)};const r=this.parseAttributes(t.attributes,{});return s=Object.assign(s,r),new e.MeshPhongMaterial(s)}getSide(t){if(!t.side)return e.BackSide;switch(t.side){case 0:case 1:return e.BackSide;case 2:return e.FrontSide;case 3:return e.DoubleSide}}getSmooth(e){return!e.smooth||!e.smooth}parseConnections(e,t){const a={maps:{}},s=e.inputName,r=e.inputNodeName,i=e.nodeName,o=this;return s.forEach((function(e,s){if("Material"===e){const e=o.getNodeByRefName(r[s],t);a.attributes=e.attributes,a.envMap=e.fileName,a.name=r[s]}})),i.forEach((function(e,i){e===a.name&&(a.maps[s[i]]=o.getNodeByRefName(r[i],t))})),a}getNodeByRefName(e,t){for(const a in t)if(t[a].refName===e)return t[a]}parseTextureNodes(t){const a={};for(const s in t){const r=t[s],i=r.fileName;if(!i)return;const o=this.loadTexture(i);switch(void 0!==r.widthWrappingMode&&(o.wrapS=this.getWrappingType(r.widthWrappingMode)),void 0!==r.heightWrappingMode&&(o.wrapT=this.getWrappingType(r.heightWrappingMode)),s){case"Color":a.map=o;break;case"Roughness":a.roughnessMap=o,a.roughness=.5;break;case"Specular":a.specularMap=o,a.specular=16777215;break;case"Luminous":a.emissiveMap=o,a.emissive=8421504;break;case"Luminous Color":a.emissive=8421504;break;case"Metallic":a.metalnessMap=o,a.metalness=.5;break;case"Transparency":case"Alpha":a.alphaMap=o,a.transparent=!0;break;case"Normal":a.normalMap=o,void 0!==r.amplitude&&(a.normalScale=new e.Vector2(r.amplitude,r.amplitude));break;case"Bump":a.bumpMap=o}}return a.roughnessMap&&a.specularMap&&delete a.specularMap,a}parseAttributeImageMaps(e,t,a){for(const s in e){const r=e[s];if(r.maps){const e=r.maps[0],i=this.getTexturePathByIndex(e.imageIndex,t);if(!i)return;const o=this.loadTexture(i);switch(void 0!==e.wrap&&(o.wrapS=this.getWrappingType(e.wrap.w)),void 0!==e.wrap&&(o.wrapT=this.getWrappingType(e.wrap.h)),s){case"Color":a.map=o;break;case"Diffuse":a.aoMap=o;break;case"Roughness":a.roughnessMap=o,a.roughness=1;break;case"Specular":a.specularMap=o,a.specular=16777215;break;case"Luminosity":a.emissiveMap=o,a.emissive=8421504;break;case"Metallic":a.metalnessMap=o,a.metalness=1;break;case"Transparency":case"Alpha":a.alphaMap=o,a.transparent=!0;break;case"Normal":a.normalMap=o;break;case"Bump":a.bumpMap=o}}}}parseAttributes(t,a){const s={};return t.Color&&!a.map?s.color=(new e.Color).fromArray(t.Color.value):s.color=new e.Color,t.Transparency&&0!==t.Transparency.value&&(s.opacity=1-t.Transparency.value,s.transparent=!0),t["Bump Height"]&&(s.bumpScale=.1*t["Bump Height"].value),t["Refraction Index"]&&(s.refractionRatio=1/t["Refraction Index"].value),this.parsePhysicalAttributes(s,t,a),this.parseStandardAttributes(s,t,a),this.parsePhongAttributes(s,t,a),s}parsePhysicalAttributes(e,t){t.Clearcoat&&t.Clearcoat.value>0&&(e.clearcoat=t.Clearcoat.value,t["Clearcoat Gloss"]&&(e.clearcoatRoughness=.5*(1-t["Clearcoat Gloss"].value)))}parseStandardAttributes(t,a,s){a.Luminous&&(t.emissiveIntensity=a.Luminous.value,a["Luminous Color"]&&!s.emissive?t.emissive=(new e.Color).fromArray(a["Luminous Color"].value):t.emissive=new e.Color(8421504)),a.Roughness&&!s.roughnessMap&&(t.roughness=a.Roughness.value),a.Metallic&&!s.metalnessMap&&(t.metalness=a.Metallic.value)}parsePhongAttributes(t,a,s){a.Diffuse&&t.color.multiplyScalar(a.Diffuse.value),a.Reflection&&(t.reflectivity=a.Reflection.value,t.combine=e.AddOperation),a.Luminosity&&(t.emissiveIntensity=a.Luminosity.value,s.emissiveMap||s.map?t.emissive=new e.Color(8421504):t.emissive=t.color),a.Roughness||!a.Specular||s.specularMap||(a["Color Highlight"]?t.specular=(new e.Color).setScalar(a.Specular.value).lerp(t.color.clone().multiplyScalar(a.Specular.value),a["Color Highlight"].value):t.specular=(new e.Color).setScalar(a.Specular.value)),t.specular&&a.Glossiness&&(t.shininess=7+Math.pow(2,12*a.Glossiness.value+2))}parseEnvMap(t,a,s){if(t.envMap){const r=this.loadTexture(t.envMap);s.transparent&&s.opacity<.999?(r.mapping=e.EquirectangularRefractionMapping,void 0!==s.reflectivity&&(delete s.reflectivity,delete s.combine),void 0!==s.metalness&&delete s.metalness):r.mapping=e.EquirectangularReflectionMapping,a.envMap=r}}getTexturePathByIndex(e){let t="";return a.textures?(a.textures.forEach((function(a){a.index===e&&(t=a.fileName)})),t):t}loadTexture(e){if(!e)return null;return this.textureLoader.load(e,void 0,void 0,(function(){console.warn("LWOLoader: non-standard resource hierarchy. Use `resourcePath` parameter to specify root content directory.")}))}getWrappingType(t){switch(t){case 0:return console.warn('LWOLoader: "Reset" texture wrapping type is not supported in three.js'),e.ClampToEdgeWrapping;case 1:return e.RepeatWrapping;case 2:return e.MirroredRepeatWrapping;case 3:return e.ClampToEdgeWrapping}}getMaterialType(t){return t.Clearcoat&&t.Clearcoat.value>0?e.MeshPhysicalMaterial:t.Roughness?e.MeshStandardMaterial:e.MeshPhongMaterial}}class o{parse(t,a){const s=new e.BufferGeometry;s.setAttribute("position",new e.Float32BufferAttribute(t.points,3));const r=this.splitIndices(t.vertexIndices,t.polygonDimensions);return s.setIndex(r),this.parseGroups(s,t),s.computeVertexNormals(),this.parseUVs(s,a,r),this.parseMorphTargets(s,a,r),s.translate(-a.pivot[0],-a.pivot[1],-a.pivot[2]),s}splitIndices(e,t){const a=[];let s=0;return t.forEach((function(t){if(t<4)for(let r=0;r<t;r++)a.push(e[s+r]);else if(4===t)a.push(e[s],e[s+1],e[s+2],e[s],e[s+2],e[s+3]);else if(t>4){for(let r=1;r<t-1;r++)a.push(e[s],e[s+r],e[s+r+1]);console.warn("LWOLoader: polygons with greater than 4 sides are not supported")}s+=t})),a}parseGroups(e,t){const s=a.tags,r=[];let i=3;"lines"===t.type&&(i=2),"points"===t.type&&(i=1);const o=this.splitMaterialIndices(t.polygonDimensions,t.materialIndices);let n=0;const p={};let u,l,c=0,h=0;for(let t=0;t<o.length;t+=2){if(l=o[t+1],0===t&&(r[n]=s[l]),void 0===u&&(u=l),l!==u){let t;p[s[u]]?t=p[s[u]]:(t=n,p[s[u]]=n,r[n]=s[u],n++),e.addGroup(c,h,t),c+=h,u=l,h=0}h+=i}if(e.groups.length>0){let t;p[s[l]]?t=p[s[l]]:(t=n,p[s[l]]=n,r[n]=s[l]),e.addGroup(c,h,t)}e.userData.matNames=r}splitMaterialIndices(e,t){const a=[];return e.forEach((function(e,s){if(e<=3)a.push(t[2*s],t[2*s+1]);else if(4===e)a.push(t[2*s],t[2*s+1],t[2*s],t[2*s+1]);else for(let r=0;r<e-2;r++)a.push(t[2*s],t[2*s+1])})),a}parseUVs(t,a){const s=Array.from(Array(2*t.attributes.position.count),(function(){return 0}));for(const e in a.uvs){const t=a.uvs[e].uvs;a.uvs[e].uvIndices.forEach((function(e,a){s[2*e]=t[2*a],s[2*e+1]=t[2*a+1]}))}t.setAttribute("uv",new e.Float32BufferAttribute(s,2))}parseMorphTargets(t,a){let s=0;for(const r in a.morphTargets){const i=t.attributes.position.array.slice();t.morphAttributes.position||(t.morphAttributes.position=[]);const o=a.morphTargets[r].points,n=a.morphTargets[r].indices,p=a.morphTargets[r].type;n.forEach((function(e,t){"relative"===p?(i[3*e]+=o[3*t],i[3*e+1]+=o[3*t+1],i[3*e+2]+=o[3*t+2]):(i[3*e]=o[3*t],i[3*e+1]=o[3*t+1],i[3*e+2]=o[3*t+2])})),t.morphAttributes.position[s]=new e.Float32BufferAttribute(i,3),t.morphAttributes.position[s].name=r,s++}t.morphTargetsRelative=!1}}exports.LWOLoader=s;
