"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("three"),t=require("fflate");class n extends e.Loader{constructor(e){super(e)}load(t,n,o,a){const r=this,l=new e.FileLoader(r.manager);l.setPath(r.path),l.setResponseType("arraybuffer"),l.setRequestHeader(r.requestHeader),l.setWithCredentials(r.withCredentials),l.load(t,(function(e){try{n(r.parse(e))}catch(e){a?a(e):console.error(e),r.manager.itemError(t)}}),o,a)}parse(n){function o(t){let n="AMF Material";const o=t.attributes.id.textContent;let r={r:1,g:1,b:1,a:1},l=null;for(let e=0;e<t.childNodes.length;e++){const o=t.childNodes[e];"metadata"===o.nodeName&&void 0!==o.attributes.type?"name"===o.attributes.type.value&&(n=o.textContent):"color"===o.nodeName&&(r=a(o))}return l=new e.MeshPhongMaterial({flatShading:!0,color:new e.Color(r.r,r.g,r.b),name:n}),1!==r.a&&(l.transparent=!0,l.opacity=r.a),{id:o,material:l}}function a(e){const t={r:1,g:1,b:1,a:1};for(let n=0;n<e.childNodes.length;n++){const o=e.childNodes[n];"r"===o.nodeName?t.r=o.textContent:"g"===o.nodeName?t.g=o.textContent:"b"===o.nodeName?t.b=o.textContent:"a"===o.nodeName&&(t.a=o.textContent)}return t}function r(e){const t={name:"",triangles:[],materialid:null};let n=e.firstElementChild;for(void 0!==e.attributes.materialid&&(t.materialId=e.attributes.materialid.nodeValue);n;){if("metadata"===n.nodeName)void 0!==n.attributes.type&&"name"===n.attributes.type.value&&(t.name=n.textContent);else if("triangle"===n.nodeName){const e=n.getElementsByTagName("v1")[0].textContent,o=n.getElementsByTagName("v2")[0].textContent,a=n.getElementsByTagName("v3")[0].textContent;t.triangles.push(e,o,a)}n=n.nextElementSibling}return t}function l(e){const t=[],n=[];let o=e.firstElementChild;for(;o;){if("vertex"===o.nodeName){let e=o.firstElementChild;for(;e;){if("coordinates"===e.nodeName){const n=e.getElementsByTagName("x")[0].textContent,o=e.getElementsByTagName("y")[0].textContent,a=e.getElementsByTagName("z")[0].textContent;t.push(n,o,a)}else if("normal"===e.nodeName){const t=e.getElementsByTagName("nx")[0].textContent,o=e.getElementsByTagName("ny")[0].textContent,a=e.getElementsByTagName("nz")[0].textContent;n.push(t,o,a)}e=e.nextElementSibling}}o=o.nextElementSibling}return{vertices:t,normals:n}}function s(e){const t=e.attributes.id.textContent,n={name:"amfobject",meshes:[]};let o=null,s=e.firstElementChild;for(;s;){if("metadata"===s.nodeName)void 0!==s.attributes.type&&"name"===s.attributes.type.value&&(n.name=s.textContent);else if("color"===s.nodeName)o=a(s);else if("mesh"===s.nodeName){let e=s.firstElementChild;const t={vertices:[],normals:[],volumes:[],color:o};for(;e;){if("vertices"===e.nodeName){const n=l(e);t.normals=t.normals.concat(n.normals),t.vertices=t.vertices.concat(n.vertices)}else"volume"===e.nodeName&&t.volumes.push(r(e));e=e.nextElementSibling}n.meshes.push(t)}s=s.nextElementSibling}return{id:t,obj:n}}const i=function(n){let o=new DataView(n);if("PK"===String.fromCharCode(o.getUint8(0),o.getUint8(1))){let e=null,a=null;console.log("THREE.AMFLoader: Loading Zip");try{e=t.unzipSync(new Uint8Array(n))}catch(e){if(e instanceof ReferenceError)return console.log("THREE.AMFLoader: fflate missing and file is compressed."),null}for(a in e)if(".amf"===a.toLowerCase().substr(-4))break;console.log("THREE.AMFLoader: Trying to load file asset: "+a),o=new DataView(e[a].buffer)}const a=e.LoaderUtils.decodeText(o),r=(new DOMParser).parseFromString(a,"application/xml");return"amf"!==r.documentElement.nodeName.toLowerCase()?(console.log("THREE.AMFLoader: Error loading AMF - no AMF document found."),null):r}(n);let m="",d="";const c=function(e){let t=1,n="millimeter";void 0!==e.documentElement.attributes.unit&&(n=e.documentElement.attributes.unit.value.toLowerCase());const o={millimeter:1,inch:25.4,feet:304.8,meter:1e3,micron:.001};return void 0!==o[n]&&(t=o[n]),console.log("THREE.AMFLoader: Unit scale: "+t),t}(i),u={},f={},g=i.documentElement.childNodes;let h,b;for(h=0;h<g.length;h++){const e=g[h];if("metadata"===e.nodeName)void 0!==e.attributes.type&&("name"===e.attributes.type.value?m=e.textContent:"author"===e.attributes.type.value&&(d=e.textContent));else if("material"===e.nodeName){const t=o(e);u[t.id]=t.material}else if("object"===e.nodeName){const t=s(e);f[t.id]=t.obj}}const p=new e.Group,E=new e.MeshPhongMaterial({color:11184895,flatShading:!0});p.name=m,p.userData.author=d,p.userData.loader="AMF";for(const t in f){const n=f[t],o=n.meshes,a=new e.Group;for(a.name=n.name||"",h=0;h<o.length;h++){let t=E;const n=o[h],r=new e.Float32BufferAttribute(n.vertices,3);let l=null;if(n.normals.length&&(l=new e.Float32BufferAttribute(n.normals,3)),n.color){const o=n.color;t=E.clone(),t.color=new e.Color(o.r,o.g,o.b),1!==o.a&&(t.transparent=!0,t.opacity=o.a)}const s=n.volumes;for(b=0;b<s.length;b++){const n=s[b],o=new e.BufferGeometry;let i=t;o.setIndex(n.triangles),o.setAttribute("position",r.clone()),l&&o.setAttribute("normal",l.clone()),void 0!==u[n.materialId]&&(i=u[n.materialId]),o.scale(c,c,c),a.add(new e.Mesh(o,i.clone()))}}p.add(a)}return p}}exports.AMFLoader=n;
