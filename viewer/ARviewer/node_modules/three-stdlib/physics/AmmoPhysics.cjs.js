"use strict";function t(t,e,n,o){const i=e.x(),s=e.y(),r=e.z(),a=e.w(),c=i+i,d=s+s,l=r+r,u=i*c,w=i*d,y=i*l,f=s*d,g=s*l,b=r*l,h=a*c,m=a*d,p=a*l;n[o+0]=1-(f+b),n[o+1]=w+p,n[o+2]=y-m,n[o+3]=0,n[o+4]=w-p,n[o+5]=1-(u+b),n[o+6]=g+h,n[o+7]=0,n[o+8]=y+m,n[o+9]=g-h,n[o+10]=1-(u+f),n[o+11]=0,n[o+12]=t.x(),n[o+13]=t.y(),n[o+14]=t.z(),n[o+15]=1}Object.defineProperty(exports,"__esModule",{value:!0}),exports.AmmoPhysics=async function(){if("Ammo"in window==!1)return void console.error("AmmoPhysics: Couldn't find Ammo.js");const e=await Ammo(),n=new e.btDefaultCollisionConfiguration,o=new e.btCollisionDispatcher(n),i=new e.btDbvtBroadphase,s=new e.btSequentialImpulseConstraintSolver,r=new e.btDiscreteDynamicsWorld(o,i,s,n);r.setGravity(new e.btVector3(0,-9.8,0));const a=new e.btTransform,c=[],d=new WeakMap;let l=0;return setInterval((function(){const e=performance.now();if(l>0){const t=(e-l)/1e3;r.stepSimulation(t,10)}l=e;for(let e=0,n=c.length;e<n;e++){const n=c[e];if(n.isInstancedMesh){const e=n.instanceMatrix.array,o=d.get(n);for(let n=0;n<o.length;n++){o[n].getMotionState().getWorldTransform(a);t(a.getOrigin(),a.getRotation(),e,16*n)}n.instanceMatrix.needsUpdate=!0}else if(n.isMesh){d.get(n).getMotionState().getWorldTransform(a);const t=a.getOrigin(),e=a.getRotation();n.position.set(t.x(),t.y(),t.z()),n.quaternion.set(e.x(),e.y(),e.z(),e.w())}}}),1e3/60),{addMesh:function(t,n=0){const o=function(t){const n=t.parameters;if("BoxGeometry"===t.type){const t=void 0!==n.width?n.width/2:.5,o=void 0!==n.height?n.height/2:.5,i=void 0!==n.depth?n.depth/2:.5,s=new e.btBoxShape(new e.btVector3(t,o,i));return s.setMargin(.05),s}if("SphereGeometry"===t.type||"IcosahedronGeometry"===t.type){const t=void 0!==n.radius?n.radius:1,o=new e.btSphereShape(t);return o.setMargin(.05),o}return null}(t.geometry);null!==o&&(t.isInstancedMesh?function(t,n,o){const i=t.instanceMatrix.array,s=[];for(let a=0;a<t.count;a++){const t=16*a,c=new e.btTransform;c.setFromOpenGLMatrix(i.slice(t,t+16));const d=new e.btDefaultMotionState(c),l=new e.btVector3(0,0,0);o.calculateLocalInertia(n,l);const u=new e.btRigidBodyConstructionInfo(n,d,o,l),w=new e.btRigidBody(u);r.addRigidBody(w),s.push(w)}n>0&&(t.instanceMatrix.setUsage(35048),c.push(t),d.set(t,s))}(t,n,o):t.isMesh&&function(t,n,o){const i=t.position,s=t.quaternion,a=new e.btTransform;a.setIdentity(),a.setOrigin(new e.btVector3(i.x,i.y,i.z)),a.setRotation(new e.btQuaternion(s.x,s.y,s.z,s.w));const l=new e.btDefaultMotionState(a),u=new e.btVector3(0,0,0);o.calculateLocalInertia(n,u);const w=new e.btRigidBodyConstructionInfo(n,l,o,u),y=new e.btRigidBody(w);r.addRigidBody(y),n>0&&(c.push(t),d.set(t,y))}(t,n,o))},setMeshPosition:function(t,n,o=0){if(t.isInstancedMesh){const i=d.get(t)[o];i.setAngularVelocity(new e.btVector3(0,0,0)),i.setLinearVelocity(new e.btVector3(0,0,0)),a.setIdentity(),a.setOrigin(new e.btVector3(n.x,n.y,n.z)),i.setWorldTransform(a)}else if(t.isMesh){const o=d.get(t);o.setAngularVelocity(new e.btVector3(0,0,0)),o.setLinearVelocity(new e.btVector3(0,0,0)),a.setIdentity(),a.setOrigin(new e.btVector3(n.x,n.y,n.z)),o.setWorldTransform(a)}}}};
