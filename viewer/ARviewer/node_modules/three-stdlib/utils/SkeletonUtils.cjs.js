"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e,t,r,n,o,i,s,a,l,p,m,u,c=require("three"),x={retarget:(s=new c.Vector3,a=new c.Quaternion,l=new c.Vector3,p=new c.Matrix4,m=new c.Matrix4,u=new c.Matrix4,function(e,t,r){(r=r||{}).preserveMatrix=void 0===r.preserveMatrix||r.preserveMatrix,r.preservePosition=void 0===r.preservePosition||r.preservePosition,r.preserveHipPosition=void 0!==r.preserveHipPosition&&r.preserveHipPosition,r.useTargetMatrix=void 0!==r.useTargetMatrix&&r.useTargetMatrix,r.hip=void 0!==r.hip?r.hip:"hip",r.names=r.names||{};var n,o,i,c,x,d,f=t.isObject3D?t.skeleton.bones:this.getBones(t),h=e.isObject3D?e.skeleton.bones:this.getBones(e);if(e.isObject3D?e.skeleton.pose():(r.useTargetMatrix=!0,r.preserveMatrix=!1),r.preservePosition)for(x=[],d=0;d<h.length;d++)x.push(h[d].position.clone());if(r.preserveMatrix)for(e.updateMatrixWorld(),e.matrixWorld.identity(),d=0;d<e.children.length;++d)e.children[d].updateMatrixWorld(!0);if(r.offsets)for(n=[],d=0;d<h.length;++d)o=h[d],i=r.names[o.name]||o.name,r.offsets&&r.offsets[i]&&(o.matrix.multiply(r.offsets[i]),o.matrix.decompose(o.position,o.quaternion,o.scale),o.updateMatrixWorld()),n.push(o.matrixWorld.clone());for(d=0;d<h.length;++d){if(o=h[d],i=r.names[o.name]||o.name,c=this.getBoneByName(i,f),u.copy(o.matrixWorld),c){if(c.updateMatrixWorld(),r.useTargetMatrix?m.copy(c.matrixWorld):(m.copy(e.matrixWorld).invert(),m.multiply(c.matrixWorld)),l.setFromMatrixScale(m),m.scale(l.set(1/l.x,1/l.y,1/l.z)),u.makeRotationFromQuaternion(a.setFromRotationMatrix(m)),e.isObject3D){var v=h.indexOf(o),g=n?n[v]:p.copy(e.skeleton.boneInverses[v]).invert();u.multiply(g)}u.copyPosition(m)}o.parent&&o.parent.isBone?(o.matrix.copy(o.parent.matrixWorld).invert(),o.matrix.multiply(u)):o.matrix.copy(u),r.preserveHipPosition&&i===r.hip&&o.matrix.setPosition(s.set(0,o.position.y,0)),o.matrix.decompose(o.position,o.quaternion,o.scale),o.updateMatrixWorld()}if(r.preservePosition)for(d=0;d<h.length;++d)o=h[d],(i=r.names[o.name]||o.name)!==r.hip&&o.position.copy(x[d]);r.preserveMatrix&&e.updateMatrixWorld(!0)}),retargetClip:function(e,t,r,n){(n=n||{}).useFirstFramePosition=void 0!==n.useFirstFramePosition&&n.useFirstFramePosition,n.fps=void 0!==n.fps?n.fps:30,n.names=n.names||[],t.isObject3D||(t=this.getHelperFromSkeleton(t));var o,i,s,a,l,p,m=Math.round(r.duration*(n.fps/1e3)*1e3),u=1/n.fps,x=[],d=new c.AnimationMixer(t),f=this.getBones(e.skeleton),h=[];for(d.clipAction(r).play(),d.update(0),t.updateMatrixWorld(),l=0;l<m;++l){var v=l*u;for(this.retarget(e,t,n),p=0;p<f.length;++p)a=n.names[f[p].name]||f[p].name,this.getBoneByName(a,t.skeleton)&&(i=f[p],s=h[p]=h[p]||{bone:i},n.hip===a&&(s.pos||(s.pos={times:new Float32Array(m),values:new Float32Array(3*m)}),n.useFirstFramePosition&&(0===l&&(o=i.position.clone()),i.position.sub(o)),s.pos.times[l]=v,i.position.toArray(s.pos.values,3*l)),s.quat||(s.quat={times:new Float32Array(m),values:new Float32Array(4*m)}),s.quat.times[l]=v,i.quaternion.toArray(s.quat.values,4*l));d.update(u),t.updateMatrixWorld()}for(l=0;l<h.length;++l)(s=h[l])&&(s.pos&&x.push(new c.VectorKeyframeTrack(".bones["+s.bone.name+"].position",s.pos.times,s.pos.values)),x.push(new c.QuaternionKeyframeTrack(".bones["+s.bone.name+"].quaternion",s.quat.times,s.quat.values)));return d.uncacheAction(r),new c.AnimationClip(r.name,-1,x)},getHelperFromSkeleton:function(e){var t=new c.SkeletonHelper(e.bones[0]);return t.skeleton=e,t},getSkeletonOffsets:(e=new c.Vector3,t=new c.Vector3,r=new c.Vector3,n=new c.Vector3,o=new c.Vector2,i=new c.Vector2,function(s,a,l){(l=l||{}).hip=void 0!==l.hip?l.hip:"hip",l.names=l.names||{},a.isObject3D||(a=this.getHelperFromSkeleton(a));var p,m,u,x,d=Object.keys(l.names),f=Object.values(l.names),h=a.isObject3D?a.skeleton.bones:this.getBones(a),v=s.isObject3D?s.skeleton.bones:this.getBones(s),g=[];for(s.skeleton.pose(),x=0;x<v.length;++x)if(p=v[x],u=l.names[p.name]||p.name,(m=this.getBoneByName(u,h))&&u!==l.hip){var M=this.getNearestBone(p.parent,d),y=this.getNearestBone(m.parent,f);M.updateMatrixWorld(),y.updateMatrixWorld(),e.setFromMatrixPosition(M.matrixWorld),t.setFromMatrixPosition(p.matrixWorld),r.setFromMatrixPosition(y.matrixWorld),n.setFromMatrixPosition(m.matrixWorld),o.subVectors(new c.Vector2(t.x,t.y),new c.Vector2(e.x,e.y)).normalize(),i.subVectors(new c.Vector2(n.x,n.y),new c.Vector2(r.x,r.y)).normalize();var b=o.angle()-i.angle(),w=(new c.Matrix4).makeRotationFromEuler(new c.Euler(0,0,b));p.matrix.multiply(w),p.matrix.decompose(p.position,p.quaternion,p.scale),p.updateMatrixWorld(),g[u]=w}return g}),renameBones:function(e,t){var r=this.getBones(e);for(let e=0;e<r.length;++e){var n=r[e];t[n.name]&&(n.name=t[n.name])}return this},getBones:function(e){return Array.isArray(e)?e:e.bones},getBoneByName:function(e,t){for(let r=0,n=this.getBones(t);r<n.length;r++)if(e===n[r].name)return n[r]},getNearestBone:function(e,t){for(;e.isBone;){if(-1!==t.indexOf(e.name))return e;e=e.parent}},findBoneTrackData:function(e,t){var r=/\[(.*)\]\.(.*)/,n={name:e};for(let i=0;i<t.length;++i){var o=r.exec(t[i].name);o&&e===o[1]&&(n[o[2]]=i)}return n},getEqualsBonesNames:function(e,t){var r=this.getBones(e),n=this.getBones(t),o=[];e:for(let e=0;e<r.length;e++){var i=r[e].name;for(let e=0;e<n.length;e++)if(i===n[e].name){o.push(i);continue e}}return o},clone:function(e){var t=new Map,r=new Map,n=e.clone();return d(e,n,(function(e,n){t.set(n,e),r.set(e,n)})),n.traverse((function(e){if(e.isSkinnedMesh){var n=e,o=t.get(e),i=o.skeleton.bones;n.skeleton=o.skeleton.clone(),n.bindMatrix.copy(o.bindMatrix),n.skeleton.bones=i.map((function(e){return r.get(e)})),n.bind(n.skeleton,n.bindMatrix)}})),n}};function d(e,t,r){r(e,t);for(let n=0;n<e.children.length;n++)d(e.children[n],t.children[n],r)}exports.SkeletonUtils=x;
