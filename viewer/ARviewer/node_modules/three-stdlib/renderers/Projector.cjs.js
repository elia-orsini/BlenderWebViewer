"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("three"),r=function(){this.id=0,this.object=null,this.z=0,this.renderOrder=0},t=function(){this.id=0,this.v1=new i,this.v2=new i,this.v3=new i,this.normalModel=new e.Vector3,this.vertexNormalsModel=[new e.Vector3,new e.Vector3,new e.Vector3],this.vertexNormalsLength=0,this.color=new e.Color,this.material=null,this.uvs=[new e.Vector2,new e.Vector2,new e.Vector2],this.z=0,this.renderOrder=0},i=function(){this.position=new e.Vector3,this.positionWorld=new e.Vector3,this.positionScreen=new e.Vector4,this.visible=!0};i.prototype.copy=function(e){this.positionWorld.copy(e.positionWorld),this.positionScreen.copy(e.positionScreen)};var o=function(){this.id=0,this.v1=new i,this.v2=new i,this.vertexColors=[new e.Color,new e.Color],this.material=null,this.z=0,this.renderOrder=0},n=function(){this.id=0,this.object=null,this.x=0,this.y=0,this.z=0,this.rotation=0,this.scale=new e.Vector2,this.material=null,this.renderOrder=0};exports.Projector=function(){var s,l,a,c,p,u,h,f,d,m,v,y=[],x=0,g=[],w=0,M=[],b=0,j=[],S=0,z=[],V=0,O={objects:[],lights:[],elements:[]},E=new e.Vector3,T=new e.Vector4,R=new e.Box3(new e.Vector3(-1,-1,-1),new e.Vector3(1,1,1)),C=new e.Box3,P=new Array(3),G=new e.Matrix4,W=new e.Matrix4,B=new e.Matrix4,L=new e.Frustum;this.projectVector=function(e,r){console.warn("THREE.Projector: .projectVector() is now vector.project()."),e.project(r)},this.unprojectVector=function(e,r){console.warn("THREE.Projector: .unprojectVector() is now vector.unproject()."),e.unproject(r)},this.pickingRay=function(){console.error("THREE.Projector: .pickingRay() is now raycaster.setFromCamera().")};var A=new function(){var r=[],t=[],n=[],s=null,l=new e.Matrix3;function u(e){var r=e.position,t=e.positionWorld,i=e.positionScreen;t.copy(r).applyMatrix4(v),i.copy(t).applyMatrix4(W);var o=1/i.w;i.x*=o,i.y*=o,i.z*=o,e.visible=i.x>=-1&&i.x<=1&&i.y>=-1&&i.y<=1&&i.z>=-1&&i.z<=1}function d(e,r,t){return!0===e.visible||!0===r.visible||!0===t.visible||(P[0]=e.positionScreen,P[1]=r.positionScreen,P[2]=t.positionScreen,R.intersectsBox(C.setFromPoints(P)))}function m(e,r,t){return(t.positionScreen.x-e.positionScreen.x)*(r.positionScreen.y-e.positionScreen.y)-(t.positionScreen.y-e.positionScreen.y)*(r.positionScreen.x-e.positionScreen.x)<0}return{setObject:function(e){s=e,l.getNormalMatrix(s.matrixWorld),r.length=0,t.length=0,n.length=0},projectVertex:u,checkTriangleVisibility:d,checkBackfaceCulling:m,pushVertex:function(e,r,t){(a=function(){if(c===w){var e=new i;return g.push(e),w++,c++,e}return g[c++]}()).position.set(e,r,t),u(a)},pushNormal:function(e,t,i){r.push(e,t,i)},pushColor:function(e,r,i){t.push(e,r,i)},pushUv:function(e,r){n.push(e,r)},pushLine:function(e,r){var i,n,l,a,c,p,u,d,m=g[e],v=g[r];m.positionScreen.copy(m.position).applyMatrix4(B),v.positionScreen.copy(v.position).applyMatrix4(B),!0==(i=m.positionScreen,n=v.positionScreen,l=0,a=1,c=i.z+i.w,p=n.z+n.w,u=-i.z+i.w,d=-n.z+n.w,c>=0&&p>=0&&u>=0&&d>=0||!(c<0&&p<0||u<0&&d<0)&&(c<0?l=Math.max(l,c/(c-p)):p<0&&(a=Math.min(a,c/(c-p))),u<0?l=Math.max(l,u/(u-d)):d<0&&(a=Math.min(a,u/(u-d))),!(a<l||(i.lerp(n,l),n.lerp(i,1-a),0))))&&(m.positionScreen.multiplyScalar(1/m.positionScreen.w),v.positionScreen.multiplyScalar(1/v.positionScreen.w),(h=function(){if(f===S){var e=new o;return j.push(e),S++,f++,e}return j[f++]}()).id=s.id,h.v1.copy(m),h.v2.copy(v),h.z=Math.max(m.positionScreen.z,v.positionScreen.z),h.renderOrder=s.renderOrder,h.material=s.material,s.material.vertexColors&&(h.vertexColors[0].fromArray(t,3*e),h.vertexColors[1].fromArray(t,3*r)),O.elements.push(h))},pushTriangle:function(i,o,a,c){var u=g[i],h=g[o],f=g[a];if(!1!==d(u,h,f)&&(c.side===e.DoubleSide||!0===m(u,h,f))){(p=U()).id=s.id,p.v1.copy(u),p.v2.copy(h),p.v3.copy(f),p.z=(u.positionScreen.z+h.positionScreen.z+f.positionScreen.z)/3,p.renderOrder=s.renderOrder,E.subVectors(f.position,h.position),T.subVectors(u.position,h.position),E.cross(T),p.normalModel.copy(E),p.normalModel.applyMatrix3(l).normalize();for(let e=0;e<3;e++){var v=p.vertexNormalsModel[e];v.fromArray(r,3*arguments[e]),v.applyMatrix3(l).normalize();var y=p.uvs[e];y.fromArray(n,2*arguments[e])}p.vertexNormalsLength=3,p.material=c,c.vertexColors&&p.color.fromArray(t,3*i),O.elements.push(p)}}}};function H(e){if(!1!==e.visible){if(e.isLight)O.lights.push(e);else if(e.isMesh||e.isLine||e.isPoints){if(!1===e.material.visible)return;if(!0===e.frustumCulled&&!1===L.intersectsObject(e))return;N(e)}else if(e.isSprite){if(!1===e.material.visible)return;if(!0===e.frustumCulled&&!1===L.intersectsSprite(e))return;N(e)}var r=e.children;for(let e=0,t=r.length;e<t;e++)H(r[e])}}function N(e){(s=function(){if(l===x){var e=new r;return y.push(e),x++,l++,e}return y[l++]}()).id=e.id,s.object=e,E.setFromMatrixPosition(e.matrixWorld),E.applyMatrix4(W),s.z=E.z,s.renderOrder=e.renderOrder,O.objects.push(s)}function F(e,r,t){var i=1/e.w;e.z*=i,e.z>=-1&&e.z<=1&&((d=function(){if(m===V){var e=new n;return z.push(e),V++,m++,e}return z[m++]}()).id=r.id,d.x=e.x*i,d.y=e.y*i,d.z=e.z,d.renderOrder=r.renderOrder,d.object=r,d.rotation=r.rotation,d.scale.x=r.scale.x*Math.abs(d.x-(e.x+t.projectionMatrix.elements[0])/(e.w+t.projectionMatrix.elements[12])),d.scale.y=r.scale.y*Math.abs(d.y-(e.y+t.projectionMatrix.elements[5])/(e.w+t.projectionMatrix.elements[13])),d.material=r.material,O.elements.push(d))}function U(){if(u===b){var e=new t;return M.push(e),b++,u++,e}return M[u++]}function k(e,r){return e.renderOrder!==r.renderOrder?e.renderOrder-r.renderOrder:e.z!==r.z?r.z-e.z:e.id!==r.id?e.id-r.id:0}this.projectScene=function(e,r,t,i){u=0,f=0,m=0,O.elements.length=0,!0===e.autoUpdate&&e.updateMatrixWorld(),null===r.parent&&r.updateMatrixWorld(),G.copy(r.matrixWorldInverse),W.multiplyMatrices(r.projectionMatrix,G),L.setFromProjectionMatrix(W),l=0,O.objects.length=0,O.lights.length=0,H(e),!0===t&&O.objects.sort(k);var o=O.objects;for(let e=0,t=o.length;e<t;e++){var n=o[e].object,s=n.geometry;if(A.setObject(n),v=n.matrixWorld,c=0,n.isMesh){if(s.isBufferGeometry){var a=n.material,p=Array.isArray(a),h=s.attributes,d=s.groups;if(void 0===h.position)continue;for(let e=0,r=(N=h.position.array).length;e<r;e+=3){var y=N[e],x=N[e+1],g=N[e+2];if(!0===a.morphTargets){var w=s.morphAttributes.position,M=s.morphTargetsRelative,b=n.morphTargetInfluences;for(let r=0,t=w.length;r<t;r++){var j=b[r];if(0!==j){var S=w[r];M?(y+=S.getX(e/3)*j,x+=S.getY(e/3)*j,g+=S.getZ(e/3)*j):(y+=(S.getX(e/3)-N[e])*j,x+=(S.getY(e/3)-N[e+1])*j,g+=(S.getZ(e/3)-N[e+2])*j)}}}A.pushVertex(y,x,g)}if(void 0!==h.normal){var z=h.normal.array;for(let e=0,r=z.length;e<r;e+=3)A.pushNormal(z[e],z[e+1],z[e+2])}if(void 0!==h.color)for(let e=0,r=(C=h.color.array).length;e<r;e+=3)A.pushColor(C[e],C[e+1],C[e+2]);if(void 0!==h.uv){var V=h.uv.array;for(let e=0,r=V.length;e<r;e+=2)A.pushUv(V[e],V[e+1])}if(null!==s.index){var E=s.index.array;if(d.length>0)for(let e=0;e<d.length;e++){var R=d[e];if(void 0!==(a=!0===p?n.material[R.materialIndex]:n.material))for(let e=R.start,r=R.start+R.count;e<r;e+=3)A.pushTriangle(E[e],E[e+1],E[e+2],a)}else for(let e=0,r=E.length;e<r;e+=3)A.pushTriangle(E[e],E[e+1],E[e+2],a)}else if(d.length>0)for(let e=0;e<d.length;e++){R=d[e];if(void 0!==(a=!0===p?n.material[R.materialIndex]:n.material))for(let e=R.start,r=R.start+R.count;e<r;e+=3)A.pushTriangle(e,e+1,e+2,a)}else for(let e=0,r=N.length/3;e<r;e+=3)A.pushTriangle(e,e+1,e+2,a)}else if(s.isGeometry)return void console.error("THREE.Projector no longer supports Geometry. Use THREE.BufferGeometry instead.")}else if(n.isLine){if(B.multiplyMatrices(W,v),s.isBufferGeometry){if(void 0!==(h=s.attributes).position){var C;for(let e=0,r=(N=h.position.array).length;e<r;e+=3)A.pushVertex(N[e],N[e+1],N[e+2]);if(void 0!==h.color)for(let e=0,r=(C=h.color.array).length;e<r;e+=3)A.pushColor(C[e],C[e+1],C[e+2]);if(null!==s.index){for(let e=0,r=(E=s.index.array).length;e<r;e+=2)A.pushLine(E[e],E[e+1])}else{var P=n.isLineSegments?2:1;for(let e=0,r=N.length/3-1;e<r;e+=P)A.pushLine(e,e+1)}}}else if(s.isGeometry)return void console.error("THREE.Projector no longer supports Geometry. Use THREE.BufferGeometry instead.")}else if(n.isPoints){if(B.multiplyMatrices(W,v),s.isGeometry)return void console.error("THREE.Projector no longer supports Geometry. Use THREE.BufferGeometry instead.");var N;if(s.isBufferGeometry&&void 0!==(h=s.attributes).position)for(let e=0,t=(N=h.position.array).length;e<t;e+=3)T.set(N[e],N[e+1],N[e+2],1),T.applyMatrix4(B),F(T,n,r)}else n.isSprite&&(n.modelViewMatrix.multiplyMatrices(r.matrixWorldInverse,n.matrixWorld),T.set(v.elements[12],v.elements[13],v.elements[14],1),T.applyMatrix4(W),F(T,n,r))}return!0===i&&O.elements.sort(k),O}},exports.RenderableFace=t,exports.RenderableLine=o,exports.RenderableObject=r,exports.RenderableSprite=n,exports.RenderableVertex=i;
