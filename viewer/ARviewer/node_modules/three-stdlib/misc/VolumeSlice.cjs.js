"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("three"),t=function(t,i,s){var a=this;this.volume=t,i=i||0,Object.defineProperty(this,"index",{get:function(){return i},set:function(e){return i=e,a.geometryNeedsUpdate=!0,i}}),this.axis=s||"z",this.canvas=document.createElement("canvas"),this.canvasBuffer=document.createElement("canvas"),this.updateGeometry();var h=new e.Texture(this.canvas);h.minFilter=e.LinearFilter,h.wrapS=h.wrapT=e.ClampToEdgeWrapping;var r=new e.MeshBasicMaterial({map:h,side:e.DoubleSide,transparent:!0});this.mesh=new e.Mesh(this.geometry,r),this.mesh.matrixAutoUpdate=!1,this.geometryNeedsUpdate=!0,this.repaint()};t.prototype={constructor:t,repaint:function(){this.geometryNeedsUpdate&&this.updateGeometry();var e=this.iLength,t=this.jLength,i=this.sliceAccess,s=this.volume,a=this.canvasBuffer,h=this.ctxBuffer,r=h.getImageData(0,0,e,t),n=r.data,o=s.data,c=s.upperThreshold,d=s.lowerThreshold,l=s.windowLow,m=s.windowHigh,p=0;if("label"===s.dataType)for(let s=0;s<t;s++)for(let t=0;t<e;t++){var g=o[i(t,s)];g=g>=this.colorMap.length?g%this.colorMap.length+1:g;var u=this.colorMap[g];n[4*p]=u>>24&255,n[4*p+1]=u>>16&255,n[4*p+2]=u>>8&255,n[4*p+3]=255&u,p++}else for(let s=0;s<t;s++)for(let t=0;t<e;t++){var f=o[i(t,s)],v=255;v=c>=f&&d<=f?v:0,f=(f=Math.floor(255*(f-l)/(m-l)))>255?255:f<0?0:0|f,n[4*p]=f,n[4*p+1]=f,n[4*p+2]=f,n[4*p+3]=v,p++}h.putImageData(r,0,0),this.ctx.drawImage(a,0,0,e,t,0,0,this.canvas.width,this.canvas.height),this.mesh.material.map.needsUpdate=!0},updateGeometry:function(){var t=this.volume.extractPerpendicularPlane(this.axis,this.index);this.sliceAccess=t.sliceAccess,this.jLength=t.jLength,this.iLength=t.iLength,this.matrix=t.matrix,this.canvas.width=t.planeWidth,this.canvas.height=t.planeHeight,this.canvasBuffer.width=this.iLength,this.canvasBuffer.height=this.jLength,this.ctx=this.canvas.getContext("2d"),this.ctxBuffer=this.canvasBuffer.getContext("2d"),this.geometry&&this.geometry.dispose(),this.geometry=new e.PlaneGeometry(t.planeWidth,t.planeHeight),this.mesh&&(this.mesh.geometry=this.geometry,this.mesh.matrix.identity(),this.mesh.applyMatrix4(this.matrix)),this.geometryNeedsUpdate=!1}},exports.VolumeSlice=t;
