"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("three"),t=require("../loaders/MD2Loader.cjs.js"),i=require("./MorphBlendMesh.cjs.js");exports.MD2CharacterComplex=function(){var s=this;function a(t,i){var s=new e.TextureLoader,a=[];for(let o=0;o<i.length;o++)a[o]=s.load(t+i[o],h),a[o].mapping=e.UVMapping,a[o].name=i[o],a[o].encoding=e.sRGBEncoding;return a}function o(t,a){var o=new e.MeshLambertMaterial({color:16755200,wireframe:!0,morphTargets:!0,morphNormals:!0}),h=new e.MeshLambertMaterial({color:16777215,wireframe:!1,map:a,morphTargets:!0,morphNormals:!0}),n=new i.MorphBlendMesh(t,h);return n.rotation.y=-Math.PI/2,n.materialTexture=h,n.materialWireframe=o,n.autoCreateAnimations(s.animationFPS),n}function h(){s.loadCounter-=1,0===s.loadCounter&&s.onLoadComplete()}function n(e){return 1===e?1:1-Math.pow(2,-10*e)}this.scale=1,this.animationFPS=6,this.transitionFrames=15,this.maxSpeed=275,this.maxReverseSpeed=-275,this.frontAcceleration=600,this.backAcceleration=600,this.frontDecceleration=600,this.angularSpeed=2.5,this.root=new e.Object3D,this.meshBody=null,this.meshWeapon=null,this.controls=null,this.skinsBody=[],this.skinsWeapon=[],this.weapons=[],this.currentSkin=void 0,this.onLoadComplete=function(){},this.meshes=[],this.animations={},this.loadCounter=0,this.speed=0,this.bodyOrientation=0,this.walkSpeed=this.maxSpeed,this.crouchSpeed=.5*this.maxSpeed,this.activeAnimation=null,this.oldAnimation=null,this.enableShadows=function(e){for(let t=0;t<this.meshes.length;t++)this.meshes[t].castShadow=e,this.meshes[t].receiveShadow=e},this.setVisible=function(e){for(let t=0;t<this.meshes.length;t++)this.meshes[t].visible=e,this.meshes[t].visible=e},this.shareParts=function(e){this.animations=e.animations,this.walkSpeed=e.walkSpeed,this.crouchSpeed=e.crouchSpeed,this.skinsBody=e.skinsBody,this.skinsWeapon=e.skinsWeapon;var t=o(e.meshBody.geometry,this.skinsBody[0]);t.scale.set(this.scale,this.scale,this.scale),this.root.position.y=e.root.position.y,this.root.add(t),this.meshBody=t,this.meshes.push(t);for(let t=0;t<e.weapons.length;t++){var i=o(e.weapons[t].geometry,this.skinsWeapon[t]);i.scale.set(this.scale,this.scale,this.scale),i.visible=!1,i.name=e.weapons[t].name,this.root.add(i),this.weapons[t]=i,this.meshWeapon=i,this.meshes.push(i)}},this.loadParts=function(i){this.animations=i.animations,this.walkSpeed=i.walkSpeed,this.crouchSpeed=i.crouchSpeed,this.loadCounter=2*i.weapons.length+i.skins.length+1;var n=[];for(let e=0;e<i.weapons.length;e++)n[e]=i.weapons[e][1];this.skinsBody=a(i.baseUrl+"skins/",i.skins),this.skinsWeapon=a(i.baseUrl+"skins/",n);var r=new t.MD2Loader;r.load(i.baseUrl+i.body,(function(t){var i=new e.Box3;i.setFromBufferAttribute(t.attributes.position),s.root.position.y=-s.scale*i.min.y;var a=o(t,s.skinsBody[0]);a.scale.set(s.scale,s.scale,s.scale),s.root.add(a),s.meshBody=a,s.meshes.push(a),h()}));var m=function(e,t){return function(i){var a=o(i,s.skinsWeapon[e]);a.scale.set(s.scale,s.scale,s.scale),a.visible=!1,a.name=t,s.root.add(a),s.weapons[e]=a,s.meshWeapon=a,s.meshes.push(a),h()}};for(let e=0;e<i.weapons.length;e++)r.load(i.baseUrl+i.weapons[e][0],m(e,i.weapons[e][0]))},this.setPlaybackRate=function(e){this.meshBody&&(this.meshBody.duration=this.meshBody.baseDuration/e),this.meshWeapon&&(this.meshWeapon.duration=this.meshWeapon.baseDuration/e)},this.setWireframe=function(e){e?(this.meshBody&&(this.meshBody.material=this.meshBody.materialWireframe),this.meshWeapon&&(this.meshWeapon.material=this.meshWeapon.materialWireframe)):(this.meshBody&&(this.meshBody.material=this.meshBody.materialTexture),this.meshWeapon&&(this.meshWeapon.material=this.meshWeapon.materialTexture))},this.setSkin=function(e){this.meshBody&&!1===this.meshBody.material.wireframe&&(this.meshBody.material.map=this.skinsBody[e],this.currentSkin=e)},this.setWeapon=function(e){for(let e=0;e<this.weapons.length;e++)this.weapons[e].visible=!1;var t=this.weapons[e];t&&(t.visible=!0,this.meshWeapon=t,this.activeAnimation&&(t.playAnimation(this.activeAnimation),this.meshWeapon.setAnimationTime(this.activeAnimation,this.meshBody.getAnimationTime(this.activeAnimation))))},this.setAnimation=function(e){e!==this.activeAnimation&&e&&(this.meshBody&&(this.meshBody.setAnimationWeight(e,0),this.meshBody.playAnimation(e),this.oldAnimation=this.activeAnimation,this.activeAnimation=e,this.blendCounter=this.transitionFrames),this.meshWeapon&&(this.meshWeapon.setAnimationWeight(e,0),this.meshWeapon.playAnimation(e)))},this.update=function(e){this.controls&&this.updateMovementModel(e),this.animations&&(this.updateBehaviors(),this.updateAnimations(e))},this.updateAnimations=function(e){var t=1;this.blendCounter>0&&(t=(this.transitionFrames-this.blendCounter)/this.transitionFrames,this.blendCounter-=1),this.meshBody&&(this.meshBody.update(e),this.meshBody.setAnimationWeight(this.activeAnimation,t),this.meshBody.setAnimationWeight(this.oldAnimation,1-t)),this.meshWeapon&&(this.meshWeapon.update(e),this.meshWeapon.setAnimationWeight(this.activeAnimation,t),this.meshWeapon.setAnimationWeight(this.oldAnimation,1-t))},this.updateBehaviors=function(){var e,t,i=this.controls,s=this.animations;i.crouch?(e=s.crouchMove,t=s.crouchIdle):(e=s.move,t=s.idle),i.jump&&(e=s.jump,t=s.jump),i.attack&&(i.crouch?(e=s.crouchAttack,t=s.crouchAttack):(e=s.attack,t=s.attack)),(i.moveForward||i.moveBackward||i.moveLeft||i.moveRight)&&this.activeAnimation!==e&&this.setAnimation(e),Math.abs(this.speed)<.2*this.maxSpeed&&!(i.moveLeft||i.moveRight||i.moveForward||i.moveBackward)&&this.activeAnimation!==t&&this.setAnimation(t),i.moveForward&&(this.meshBody&&(this.meshBody.setAnimationDirectionForward(this.activeAnimation),this.meshBody.setAnimationDirectionForward(this.oldAnimation)),this.meshWeapon&&(this.meshWeapon.setAnimationDirectionForward(this.activeAnimation),this.meshWeapon.setAnimationDirectionForward(this.oldAnimation))),i.moveBackward&&(this.meshBody&&(this.meshBody.setAnimationDirectionBackward(this.activeAnimation),this.meshBody.setAnimationDirectionBackward(this.oldAnimation)),this.meshWeapon&&(this.meshWeapon.setAnimationDirectionBackward(this.activeAnimation),this.meshWeapon.setAnimationDirectionBackward(this.oldAnimation)))},this.updateMovementModel=function(t){var i=this.controls;i.crouch?this.maxSpeed=this.crouchSpeed:this.maxSpeed=this.walkSpeed,this.maxReverseSpeed=-this.maxSpeed,i.moveForward&&(this.speed=e.MathUtils.clamp(this.speed+t*this.frontAcceleration,this.maxReverseSpeed,this.maxSpeed)),i.moveBackward&&(this.speed=e.MathUtils.clamp(this.speed-t*this.backAcceleration,this.maxReverseSpeed,this.maxSpeed));if(i.moveLeft&&(this.bodyOrientation+=t*this.angularSpeed,this.speed=e.MathUtils.clamp(this.speed+1*t*this.frontAcceleration,this.maxReverseSpeed,this.maxSpeed)),i.moveRight&&(this.bodyOrientation-=t*this.angularSpeed,this.speed=e.MathUtils.clamp(this.speed+1*t*this.frontAcceleration,this.maxReverseSpeed,this.maxSpeed)),!i.moveForward&&!i.moveBackward)if(this.speed>0){var s=n(this.speed/this.maxSpeed);this.speed=e.MathUtils.clamp(this.speed-s*t*this.frontDecceleration,0,this.maxSpeed)}else{s=n(this.speed/this.maxReverseSpeed);this.speed=e.MathUtils.clamp(this.speed+s*t*this.backAcceleration,this.maxReverseSpeed,0)}var a=this.speed*t;this.root.position.x+=Math.sin(this.bodyOrientation)*a,this.root.position.z+=Math.cos(this.bodyOrientation)*a,this.root.rotation.y=this.bodyOrientation}};
