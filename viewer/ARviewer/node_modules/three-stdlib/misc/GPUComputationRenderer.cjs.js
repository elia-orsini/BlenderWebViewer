"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("three");exports.GPUComputationRenderer=function(r,t,n){this.variables=[],this.currentTextureIndex=0;var a=e.FloatType,i=new e.Scene,s=new e.Camera;s.position.z=1;var u={passThruTexture:{value:null}},l=h("uniform sampler2D passThruTexture;\n\nvoid main() {\n\n\tvec2 uv = gl_FragCoord.xy / resolution.xy;\n\n\tgl_FragColor = texture2D( passThruTexture, uv );\n\n}\n",u),d=new e.Mesh(new e.PlaneGeometry(2,2),l);function o(e){e.defines.resolution="vec2( "+r.toFixed(1)+", "+t.toFixed(1)+" )"}function h(r,t){t=t||{};var n=new e.ShaderMaterial({uniforms:t,vertexShader:"void main()\t{\n\n\tgl_Position = vec4( position, 1.0 );\n\n}\n",fragmentShader:r});return o(n),n}i.add(d),this.setDataType=function(e){return a=e,this},this.addVariable=function(r,t,n){var a={name:r,initialValueTexture:n,material:this.createShaderMaterial(t),dependencies:null,renderTargets:[],wrapS:null,wrapT:null,minFilter:e.NearestFilter,magFilter:e.NearestFilter};return this.variables.push(a),a},this.setVariableDependencies=function(e,r){e.dependencies=r},this.init=function(){if(!1===n.capabilities.isWebGL2&&!1===n.extensions.has("OES_texture_float"))return"No OES_texture_float support for float textures.";if(0===n.capabilities.maxVertexTextures)return"No support for vertex shader textures.";for(let n=0;n<this.variables.length;n++){var e=this.variables[n];e.renderTargets[0]=this.createRenderTarget(r,t,e.wrapS,e.wrapT,e.minFilter,e.magFilter),e.renderTargets[1]=this.createRenderTarget(r,t,e.wrapS,e.wrapT,e.minFilter,e.magFilter),this.renderTexture(e.initialValueTexture,e.renderTargets[0]),this.renderTexture(e.initialValueTexture,e.renderTargets[1]);var a=e.material,i=a.uniforms;if(null!==e.dependencies)for(let r=0;r<e.dependencies.length;r++){var s=e.dependencies[r];if(s.name!==e.name){var u=!1;for(let e=0;e<this.variables.length;e++)if(s.name===this.variables[e].name){u=!0;break}if(!u)return"Variable dependency not found. Variable="+e.name+", dependency="+s.name}i[s.name]={value:null},a.fragmentShader="\nuniform sampler2D "+s.name+";\n"+a.fragmentShader}}return this.currentTextureIndex=0,null},this.compute=function(){var e=this.currentTextureIndex,r=0===this.currentTextureIndex?1:0;for(let i=0,s=this.variables.length;i<s;i++){var t=this.variables[i];if(null!==t.dependencies){var n=t.material.uniforms;for(let r=0,i=t.dependencies.length;r<i;r++){var a=t.dependencies[r];n[a.name].value=a.renderTargets[e].texture}}this.doRenderTarget(t.material,t.renderTargets[r])}this.currentTextureIndex=r},this.getCurrentRenderTarget=function(e){return e.renderTargets[this.currentTextureIndex]},this.getAlternateRenderTarget=function(e){return e.renderTargets[0===this.currentTextureIndex?1:0]},this.addResolutionDefine=o,this.createShaderMaterial=h,this.createRenderTarget=function(n,i,s,u,l,d){return n=n||r,i=i||t,s=s||e.ClampToEdgeWrapping,u=u||e.ClampToEdgeWrapping,l=l||e.NearestFilter,d=d||e.NearestFilter,new e.WebGLRenderTarget(n,i,{wrapS:s,wrapT:u,minFilter:l,magFilter:d,format:e.RGBAFormat,type:a,depthBuffer:!1})},this.createTexture=function(){var n=new Float32Array(r*t*4);return new e.DataTexture(n,r,t,e.RGBAFormat,e.FloatType)},this.renderTexture=function(e,r){u.passThruTexture.value=e,this.doRenderTarget(l,r),u.passThruTexture.value=null},this.doRenderTarget=function(e,r){var t=n.getRenderTarget();d.material=e,n.setRenderTarget(r),n.render(i,s),d.material=l,n.setRenderTarget(t)}};
