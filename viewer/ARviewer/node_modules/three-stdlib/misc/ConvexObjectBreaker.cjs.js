"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("three"),t=require("../geometries/ConvexGeometry.cjs.js");require("../math/ConvexHull.cjs.js");var r,o=function(t,r){this.minSizeForBreak=t||1.4,this.smallDelta=r||1e-4,this.tempLine1=new e.Line3,this.tempPlane1=new e.Plane,this.tempPlane2=new e.Plane,this.tempPlane_Cut=new e.Plane,this.tempCM1=new e.Vector3,this.tempCM2=new e.Vector3,this.tempVector3=new e.Vector3,this.tempVector3_2=new e.Vector3,this.tempVector3_3=new e.Vector3,this.tempVector3_P0=new e.Vector3,this.tempVector3_P1=new e.Vector3,this.tempVector3_P2=new e.Vector3,this.tempVector3_N0=new e.Vector3,this.tempVector3_N1=new e.Vector3,this.tempVector3_AB=new e.Vector3,this.tempVector3_CB=new e.Vector3,this.tempResultObjects={object1:null,object2:null},this.segments=[];for(let e=0;e<900;e++)this.segments[e]=!1};o.prototype={constructor:o,prepareBreakableObject:function(e,t,r,o,n){e.geometry.isBufferGeometry||console.error("THREE.ConvexObjectBreaker.prepareBreakableObject(): Parameter object must have a BufferGeometry.");var s=e.userData;s.mass=t,s.velocity=r.clone(),s.angularVelocity=o.clone(),s.breakable=n},subdivideByImpact:function(e,t,r,o,n){var s=[],a=this.tempPlane1,i=this.tempPlane2;this.tempVector3.addVectors(t,r),a.setFromCoplanarPoints(t,e.position,this.tempVector3);var c=n+o,m=this;return function n(p,l,h,u){if(Math.random()<.05*u||u>c)s.push(p);else{var v=Math.PI;0===u?(i.normal.copy(a.normal),i.constant=a.constant):u<=o?(v=(h-l)*(.2+.6*Math.random())+l,m.tempVector3_2.copy(e.position).sub(t).applyAxisAngle(r,v).add(t),i.setFromCoplanarPoints(t,m.tempVector3,m.tempVector3_2)):(v=(.5*(1&u)+.2*(2-Math.random()))*Math.PI,m.tempVector3_2.copy(t).sub(p.position).applyAxisAngle(r,v).add(p.position),m.tempVector3_3.copy(r).add(p.position),i.setFromCoplanarPoints(p.position,m.tempVector3_3,m.tempVector3_2)),m.cutByPlane(p,i,m.tempResultObjects);var V=m.tempResultObjects.object1,y=m.tempResultObjects.object2;V&&n(V,l,v,u+1),y&&n(y,v,h,u+1)}}(e,0,2*Math.PI,0),s},cutByPlane:function(r,n,s){var a=r.geometry,i=a.attributes.position.array,c=a.attributes.normal.array,m=i.length/3,p=m/3,l=a.getIndex();function h(e,t){var r=3*e+t;return l?l[r]:r}l&&(p=(l=l.array).length/3);var u=[],v=[],V=this.smallDelta,y=m*m;for(let e=0;e<y;e++)this.segments[e]=!1;var d=this.tempVector3_P0,f=this.tempVector3_P1,b=this.tempVector3_N0,P=this.tempVector3_N1;for(let e=0;e<p-1;e++){var g=h(e,0),C=h(e,1),M=h(e,2);b.set(c[g],c[g]+1,c[g]+2);for(let t=e+1;t<p;t++){var j=h(t,0),x=h(t,1),_=h(t,2);P.set(c[j],c[j]+1,c[j]+2),1-b.dot(P)<V&&(g===j||g===x||g===_?C===j||C===x||C===_?(this.segments[g*m+C]=!0,this.segments[C*m+g]=!0):(this.segments[M*m+g]=!0,this.segments[g*m+M]=!0):C!==j&&C!==x&&C!==_||(this.segments[M*m+C]=!0,this.segments[C*m+M]=!0))}}var w=this.tempPlane_Cut;r.updateMatrix(),o.transformPlaneToLocalSpace(n,r.matrix,w);for(let t=0;t<p;t++){var B=h(t,0),O=h(t,1),z=h(t,2);for(let t=0;t<3;t++){var k=0===t?B:1===t?O:z,I=0===t?O:1===t?z:B;if(!this.segments[k*m+I]){this.segments[k*m+I]=!0,this.segments[I*m+k]=!0,d.set(i[3*k],i[3*k+1],i[3*k+2]),f.set(i[3*I],i[3*I+1],i[3*I+2]);var F=0;(D=w.distanceToPoint(d))>V?(F=2,v.push(d.clone())):D<-V?(F=1,u.push(d.clone())):(F=3,u.push(d.clone()),v.push(d.clone()));var D,L=0;if((D=w.distanceToPoint(f))>V?(L=2,v.push(f.clone())):D<-V?(L=1,u.push(f.clone())):(L=3,u.push(f.clone()),v.push(f.clone())),1===F&&2===L||2===F&&1===L){this.tempLine1.start.copy(d),this.tempLine1.end.copy(f);var q=new e.Vector3;if(void 0===(q=w.intersectLine(this.tempLine1,q)))return console.error("Internal error: segment does not intersect plane."),s.segmentedObject1=null,s.segmentedObject2=null,0;u.push(q),v.push(q.clone())}}}}var S=.5*r.userData.mass;this.tempCM1.set(0,0,0);var T=0,A=u.length;if(A>0){for(let e=0;e<A;e++)this.tempCM1.add(u[e]);this.tempCM1.divideScalar(A);for(let e=0;e<A;e++){(N=u[e]).sub(this.tempCM1),T=Math.max(T,N.x,N.y,N.z)}this.tempCM1.add(r.position)}this.tempCM2.set(0,0,0);var G=0,R=v.length;if(R>0){for(let e=0;e<R;e++)this.tempCM2.add(v[e]);this.tempCM2.divideScalar(R);for(let e=0;e<R;e++){var N;(N=v[e]).sub(this.tempCM2),G=Math.max(G,N.x,N.y,N.z)}this.tempCM2.add(r.position)}var E=null,H=null,J=0;return A>4&&((E=new e.Mesh(new t.ConvexGeometry(u),r.material)).position.copy(this.tempCM1),E.quaternion.copy(r.quaternion),this.prepareBreakableObject(E,S,r.userData.velocity,r.userData.angularVelocity,2*T>this.minSizeForBreak),J++),R>4&&((H=new e.Mesh(new t.ConvexGeometry(v),r.material)).position.copy(this.tempCM2),H.quaternion.copy(r.quaternion),this.prepareBreakableObject(H,S,r.userData.velocity,r.userData.angularVelocity,2*G>this.minSizeForBreak),J++),s.object1=E,s.object2=H,J}},o.transformFreeVector=function(e,t){var r=e.x,o=e.y,n=e.z,s=t.elements;return e.x=s[0]*r+s[4]*o+s[8]*n,e.y=s[1]*r+s[5]*o+s[9]*n,e.z=s[2]*r+s[6]*o+s[10]*n,e},o.transformFreeVectorInverse=function(e,t){var r=e.x,o=e.y,n=e.z,s=t.elements;return e.x=s[0]*r+s[1]*o+s[2]*n,e.y=s[4]*r+s[5]*o+s[6]*n,e.z=s[8]*r+s[9]*o+s[10]*n,e},o.transformTiedVectorInverse=function(e,t){var r=e.x,o=e.y,n=e.z,s=t.elements;return e.x=s[0]*r+s[1]*o+s[2]*n-s[12],e.y=s[4]*r+s[5]*o+s[6]*n-s[13],e.z=s[8]*r+s[9]*o+s[10]*n-s[14],e},o.transformPlaneToLocalSpace=(r=new e.Vector3,function(e,t,n){n.normal.copy(e.normal),n.constant=e.constant;var s=o.transformTiedVectorInverse(e.coplanarPoint(r),t);o.transformFreeVectorInverse(n.normal,t),n.constant=-s.dot(n.normal)}),exports.ConvexObjectBreaker=o;
