"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=require("three");const e=(()=>{function e(e,o,i,s){if("undefined"==typeof Ammo)throw new Error("THREE.MMDPhysics: Import ammo.js https://github.com/kripken/ammo.js");i=i||[],s=s||{},this.manager=new r,this.mesh=e,this.unitStep=void 0!==s.unitStep?s.unitStep:1/65,this.maxStepNum=void 0!==s.maxStepNum?s.maxStepNum:3,this.gravity=new t.Vector3(0,-98,0),void 0!==s.gravity&&this.gravity.copy(s.gravity),this.world=void 0!==s.world?s.world:null,this.bodies=[],this.constraints=[],this._init(e,o,i)}function r(){this.threeVector3s=[],this.threeMatrix4s=[],this.threeQuaternions=[],this.threeEulers=[],this.transforms=[],this.quaternions=[],this.vector3s=[]}function o(t,e,r,o){this.mesh=t,this.world=e,this.params=r,this.manager=o,this.body=null,this.bone=null,this.boneOffsetForm=null,this.boneOffsetFormInverse=null,this._init()}function i(t,e,r,o,i,s){this.mesh=t,this.world=e,this.bodyA=r,this.bodyB=o,this.params=i,this.manager=s,this.constraint=null,this._init()}function s(e,r){t.Object3D.call(this),this.root=e,this.physics=r,this.matrix.copy(e.matrixWorld),this.matrixAutoUpdate=!1,this.materials=[],this.materials.push(new t.MeshBasicMaterial({color:new t.Color(16746632),wireframe:!0,depthTest:!1,depthWrite:!1,opacity:.25,transparent:!0})),this.materials.push(new t.MeshBasicMaterial({color:new t.Color(8978312),wireframe:!0,depthTest:!1,depthWrite:!1,opacity:.25,transparent:!0})),this.materials.push(new t.MeshBasicMaterial({color:new t.Color(8947967),wireframe:!0,depthTest:!1,depthWrite:!1,opacity:.25,transparent:!0})),this._init()}return e.prototype={constructor:e,update:function(t){const e=this.manager,r=this.mesh;let o=!1;const i=e.allocThreeVector3(),s=e.allocThreeQuaternion(),n=e.allocThreeVector3();let a;return r.matrixWorld.decompose(i,s,n),1===n.x&&1===n.y&&1===n.z||(o=!0),o&&(a=r.parent,null!==a&&(r.parent=null),n.copy(this.mesh.scale),r.scale.set(1,1,1),r.updateMatrixWorld(!0)),this._updateRigidBodies(),this._stepSimulation(t),this._updateBones(),o&&(null!==a&&(r.parent=a),r.scale.copy(n)),e.freeThreeVector3(n),e.freeThreeQuaternion(s),e.freeThreeVector3(i),this},reset:function(){for(let t=0,e=this.bodies.length;t<e;t++)this.bodies[t].reset();return this},warmup:function(t){for(let e=0;e<t;e++)this.update(1/60);return this},setGravity:function(t){return this.world.setGravity(new Ammo.btVector3(t.x,t.y,t.z)),this.gravity.copy(t),this},createHelper:function(){return new s(this.mesh,this)},_init:function(t,e,r){const o=this.manager;let i=t.parent;null!==i&&(i=null);const s=o.allocThreeVector3(),n=o.allocThreeQuaternion(),a=o.allocThreeVector3();s.copy(t.position),n.copy(t.quaternion),a.copy(t.scale),t.position.set(0,0,0),t.quaternion.set(0,0,0,1),t.scale.set(1,1,1),t.updateMatrixWorld(!0),null===this.world&&(this.world=this._createWorld(),this.setGravity(this.gravity)),this._initRigidBodies(e),this._initConstraints(r),null!==i&&(t.parent=i),t.position.copy(s),t.quaternion.copy(n),t.scale.copy(a),t.updateMatrixWorld(!0),this.reset(),o.freeThreeVector3(s),o.freeThreeQuaternion(n),o.freeThreeVector3(a)},_createWorld:function(){const t=new Ammo.btDefaultCollisionConfiguration,e=new Ammo.btCollisionDispatcher(t),r=new Ammo.btDbvtBroadphase,o=new Ammo.btSequentialImpulseConstraintSolver;return new Ammo.btDiscreteDynamicsWorld(e,r,o,t)},_initRigidBodies:function(t){for(let e=0,r=t.length;e<r;e++)this.bodies.push(new o(this.mesh,this.world,t[e],this.manager))},_initConstraints:function(t){for(let e=0,r=t.length;e<r;e++){const r=t[e],o=this.bodies[r.rigidBodyIndex1],s=this.bodies[r.rigidBodyIndex2];this.constraints.push(new i(this.mesh,this.world,o,s,r,this.manager))}},_stepSimulation:function(t){const e=this.unitStep;let r=t,o=1+(t/e|0);r<e&&(r=e,o=1),o>this.maxStepNum&&(o=this.maxStepNum),this.world.stepSimulation(r,o,e)},_updateRigidBodies:function(){for(let t=0,e=this.bodies.length;t<e;t++)this.bodies[t].updateFromBone()},_updateBones:function(){for(let t=0,e=this.bodies.length;t<e;t++)this.bodies[t].updateBone()}},r.prototype={constructor:r,allocThreeVector3:function(){return this.threeVector3s.length>0?this.threeVector3s.pop():new t.Vector3},freeThreeVector3:function(t){this.threeVector3s.push(t)},allocThreeMatrix4:function(){return this.threeMatrix4s.length>0?this.threeMatrix4s.pop():new t.Matrix4},freeThreeMatrix4:function(t){this.threeMatrix4s.push(t)},allocThreeQuaternion:function(){return this.threeQuaternions.length>0?this.threeQuaternions.pop():new t.Quaternion},freeThreeQuaternion:function(t){this.threeQuaternions.push(t)},allocThreeEuler:function(){return this.threeEulers.length>0?this.threeEulers.pop():new t.Euler},freeThreeEuler:function(t){this.threeEulers.push(t)},allocTransform:function(){return this.transforms.length>0?this.transforms.pop():new Ammo.btTransform},freeTransform:function(t){this.transforms.push(t)},allocQuaternion:function(){return this.quaternions.length>0?this.quaternions.pop():new Ammo.btQuaternion},freeQuaternion:function(t){this.quaternions.push(t)},allocVector3:function(){return this.vector3s.length>0?this.vector3s.pop():new Ammo.btVector3},freeVector3:function(t){this.vector3s.push(t)},setIdentity:function(t){t.setIdentity()},getBasis:function(t){const e=this.allocQuaternion();return t.getBasis().getRotation(e),e},getBasisAsMatrix3:function(t){const e=this.getBasis(t),r=this.quaternionToMatrix3(e);return this.freeQuaternion(e),r},getOrigin:function(t){return t.getOrigin()},setOrigin:function(t,e){t.getOrigin().setValue(e.x(),e.y(),e.z())},copyOrigin:function(t,e){const r=e.getOrigin();this.setOrigin(t,r)},setBasis:function(t,e){t.setRotation(e)},setBasisFromMatrix3:function(t,e){const r=this.matrix3ToQuaternion(e);this.setBasis(t,r),this.freeQuaternion(r)},setOriginFromArray3:function(t,e){t.getOrigin().setValue(e[0],e[1],e[2])},setOriginFromThreeVector3:function(t,e){t.getOrigin().setValue(e.x,e.y,e.z)},setBasisFromArray3:function(t,e){const r=this.allocThreeQuaternion(),o=this.allocThreeEuler();o.set(e[0],e[1],e[2]),this.setBasisFromThreeQuaternion(t,r.setFromEuler(o)),this.freeThreeEuler(o),this.freeThreeQuaternion(r)},setBasisFromThreeQuaternion:function(t,e){const r=this.allocQuaternion();r.setX(e.x),r.setY(e.y),r.setZ(e.z),r.setW(e.w),this.setBasis(t,r),this.freeQuaternion(r)},multiplyTransforms:function(t,e){const r=this.allocTransform();this.setIdentity(r);const o=this.getBasisAsMatrix3(t),i=this.getBasisAsMatrix3(e),s=this.getOrigin(t),n=this.getOrigin(e),a=this.multiplyMatrix3ByVector3(o,n),h=this.addVector3(a,s);this.setOrigin(r,h);const c=this.multiplyMatrices3(o,i);return this.setBasisFromMatrix3(r,c),this.freeVector3(a),this.freeVector3(h),r},inverseTransform:function(t){const e=this.allocTransform(),r=this.getBasisAsMatrix3(t),o=this.getOrigin(t),i=this.transposeMatrix3(r),s=this.negativeVector3(o),n=this.multiplyMatrix3ByVector3(i,s);return this.setOrigin(e,n),this.setBasisFromMatrix3(e,i),this.freeVector3(s),this.freeVector3(n),e},multiplyMatrices3:function(t,e){const r=[],o=this.rowOfMatrix3(t,0),i=this.rowOfMatrix3(t,1),s=this.rowOfMatrix3(t,2),n=this.columnOfMatrix3(e,0),a=this.columnOfMatrix3(e,1),h=this.columnOfMatrix3(e,2);return r[0]=this.dotVectors3(o,n),r[1]=this.dotVectors3(o,a),r[2]=this.dotVectors3(o,h),r[3]=this.dotVectors3(i,n),r[4]=this.dotVectors3(i,a),r[5]=this.dotVectors3(i,h),r[6]=this.dotVectors3(s,n),r[7]=this.dotVectors3(s,a),r[8]=this.dotVectors3(s,h),this.freeVector3(o),this.freeVector3(i),this.freeVector3(s),this.freeVector3(n),this.freeVector3(a),this.freeVector3(h),r},addVector3:function(t,e){const r=this.allocVector3();return r.setValue(t.x()+e.x(),t.y()+e.y(),t.z()+e.z()),r},dotVectors3:function(t,e){return t.x()*e.x()+t.y()*e.y()+t.z()*e.z()},rowOfMatrix3:function(t,e){const r=this.allocVector3();return r.setValue(t[3*e+0],t[3*e+1],t[3*e+2]),r},columnOfMatrix3:function(t,e){const r=this.allocVector3();return r.setValue(t[e+0],t[e+3],t[e+6]),r},negativeVector3:function(t){const e=this.allocVector3();return e.setValue(-t.x(),-t.y(),-t.z()),e},multiplyMatrix3ByVector3:function(t,e){const r=this.allocVector3(),o=this.rowOfMatrix3(t,0),i=this.rowOfMatrix3(t,1),s=this.rowOfMatrix3(t,2),n=this.dotVectors3(o,e),a=this.dotVectors3(i,e),h=this.dotVectors3(s,e);return r.setValue(n,a,h),this.freeVector3(o),this.freeVector3(i),this.freeVector3(s),r},transposeMatrix3:function(t){const e=[];return e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8],e},quaternionToMatrix3:function(t){const e=[],r=t.x(),o=t.y(),i=t.z(),s=t.w(),n=r*r,a=o*o,h=i*i,c=r*o,l=o*i,u=i*r,m=r*s,f=o*s,p=i*s;return e[0]=1-2*(a+h),e[1]=2*(c-p),e[2]=2*(u+f),e[3]=2*(c+p),e[4]=1-2*(h+n),e[5]=2*(l-m),e[6]=2*(u-f),e[7]=2*(l+m),e[8]=1-2*(n+a),e},matrix3ToQuaternion:function(t){const e=t[0]+t[4]+t[8];let r,o,i,s,n;e>0?(r=2*Math.sqrt(e+1),n=.25*r,o=(t[7]-t[5])/r,i=(t[2]-t[6])/r,s=(t[3]-t[1])/r):t[0]>t[4]&&t[0]>t[8]?(r=2*Math.sqrt(1+t[0]-t[4]-t[8]),n=(t[7]-t[5])/r,o=.25*r,i=(t[1]+t[3])/r,s=(t[2]+t[6])/r):t[4]>t[8]?(r=2*Math.sqrt(1+t[4]-t[0]-t[8]),n=(t[2]-t[6])/r,o=(t[1]+t[3])/r,i=.25*r,s=(t[5]+t[7])/r):(r=2*Math.sqrt(1+t[8]-t[0]-t[4]),n=(t[3]-t[1])/r,o=(t[2]+t[6])/r,i=(t[5]+t[7])/r,s=.25*r);const a=this.allocQuaternion();return a.setX(o),a.setY(i),a.setZ(s),a.setW(n),a}},o.prototype={constructor:e.RigidBody,reset:function(){return this._setTransformFromBone(),this},updateFromBone:function(){return-1!==this.params.boneIndex&&0===this.params.type&&this._setTransformFromBone(),this},updateBone:function(){return 0===this.params.type||-1===this.params.boneIndex||(this._updateBoneRotation(),1===this.params.type&&this._updateBonePosition(),this.bone.updateMatrixWorld(!0),2===this.params.type&&this._setPositionFromBone()),this},_init:function(){const e=this.manager,r=this.params,o=this.mesh.skeleton.bones,i=-1===r.boneIndex?new t.Bone:o[r.boneIndex],s=function(t){switch(t.shapeType){case 0:return new Ammo.btSphereShape(t.width);case 1:return new Ammo.btBoxShape(new Ammo.btVector3(t.width,t.height,t.depth));case 2:return new Ammo.btCapsuleShape(t.width,t.height);default:throw`unknown shape type ${t.shapeType}`}}(r),n=0===r.type?0:r.weight,a=e.allocVector3();a.setValue(0,0,0),0!==n&&s.calculateLocalInertia(n,a);const h=e.allocTransform();e.setIdentity(h),e.setOriginFromArray3(h,r.position),e.setBasisFromArray3(h,r.rotation);const c=e.allocThreeVector3(),l=e.allocTransform();e.setIdentity(l),e.setOriginFromThreeVector3(l,i.getWorldPosition(c));const u=e.multiplyTransforms(l,h),m=new Ammo.btDefaultMotionState(u),f=new Ammo.btRigidBodyConstructionInfo(n,m,s,a);f.set_m_friction(r.friction),f.set_m_restitution(r.restitution);const p=new Ammo.btRigidBody(f);0===r.type&&(p.setCollisionFlags(2|p.getCollisionFlags()),p.setActivationState(4)),p.setDamping(r.positionDamping,r.rotationDamping),p.setSleepingThresholds(0,0),this.world.addRigidBody(p,1<<r.groupIndex,r.groupTarget),this.body=p,this.bone=i,this.boneOffsetForm=h,this.boneOffsetFormInverse=e.inverseTransform(h),e.freeVector3(a),e.freeTransform(u),e.freeTransform(l),e.freeThreeVector3(c)},_getBoneTransform:function(){const t=this.manager,e=t.allocThreeVector3(),r=t.allocThreeQuaternion(),o=t.allocThreeVector3();this.bone.matrixWorld.decompose(e,r,o);const i=t.allocTransform();t.setOriginFromThreeVector3(i,e),t.setBasisFromThreeQuaternion(i,r);const s=t.multiplyTransforms(i,this.boneOffsetForm);return t.freeTransform(i),t.freeThreeVector3(o),t.freeThreeQuaternion(r),t.freeThreeVector3(e),s},_getWorldTransformForBone:function(){const t=this.manager,e=this.body.getCenterOfMassTransform();return t.multiplyTransforms(e,this.boneOffsetFormInverse)},_setTransformFromBone:function(){const t=this.manager,e=this._getBoneTransform();this.body.setCenterOfMassTransform(e),this.body.getMotionState().setWorldTransform(e),t.freeTransform(e)},_setPositionFromBone:function(){const t=this.manager,e=this._getBoneTransform(),r=t.allocTransform();this.body.getMotionState().getWorldTransform(r),t.copyOrigin(r,e),this.body.setCenterOfMassTransform(r),this.body.getMotionState().setWorldTransform(r),t.freeTransform(r),t.freeTransform(e)},_updateBoneRotation:function(){const t=this.manager,e=this._getWorldTransformForBone(),r=t.getBasis(e),o=t.allocThreeQuaternion(),i=t.allocThreeQuaternion(),s=t.allocThreeQuaternion();o.set(r.x(),r.y(),r.z(),r.w()),i.setFromRotationMatrix(this.bone.matrixWorld),i.conjugate(),i.multiply(o),s.setFromRotationMatrix(this.bone.matrix),this.bone.quaternion.copy(i.multiply(s).normalize()),t.freeThreeQuaternion(o),t.freeThreeQuaternion(i),t.freeThreeQuaternion(s),t.freeQuaternion(r),t.freeTransform(e)},_updateBonePosition:function(){const t=this.manager,e=this._getWorldTransformForBone(),r=t.allocThreeVector3(),o=t.getOrigin(e);r.set(o.x(),o.y(),o.z()),this.bone.parent&&this.bone.parent.worldToLocal(r),this.bone.position.copy(r),t.freeThreeVector3(r),t.freeTransform(e)}},i.prototype={constructor:i,_init:function(){const t=this.manager,e=this.params,r=this.bodyA,o=this.bodyB,i=t.allocTransform();t.setIdentity(i),t.setOriginFromArray3(i,e.position),t.setBasisFromArray3(i,e.rotation);const s=t.allocTransform(),n=t.allocTransform();r.body.getMotionState().getWorldTransform(s),o.body.getMotionState().getWorldTransform(n);const a=t.inverseTransform(s),h=t.inverseTransform(n),c=t.multiplyTransforms(a,i),l=t.multiplyTransforms(h,i),u=new Ammo.btGeneric6DofSpringConstraint(r.body,o.body,c,l,!0),m=t.allocVector3(),f=t.allocVector3(),p=t.allocVector3(),d=t.allocVector3();m.setValue(e.translationLimitation1[0],e.translationLimitation1[1],e.translationLimitation1[2]),f.setValue(e.translationLimitation2[0],e.translationLimitation2[1],e.translationLimitation2[2]),p.setValue(e.rotationLimitation1[0],e.rotationLimitation1[1],e.rotationLimitation1[2]),d.setValue(e.rotationLimitation2[0],e.rotationLimitation2[1],e.rotationLimitation2[2]),u.setLinearLowerLimit(m),u.setLinearUpperLimit(f),u.setAngularLowerLimit(p),u.setAngularUpperLimit(d);for(let t=0;t<3;t++)0!==e.springPosition[t]&&(u.enableSpring(t,!0),u.setStiffness(t,e.springPosition[t]));for(let t=0;t<3;t++)0!==e.springRotation[t]&&(u.enableSpring(t+3,!0),u.setStiffness(t+3,e.springRotation[t]));if(void 0!==u.setParam)for(let t=0;t<6;t++)u.setParam(2,.475,t);this.world.addConstraint(u,!0),this.constraint=u,t.freeTransform(i),t.freeTransform(s),t.freeTransform(n),t.freeTransform(a),t.freeTransform(h),t.freeTransform(c),t.freeTransform(l),t.freeVector3(m),t.freeVector3(f),t.freeVector3(p),t.freeVector3(d)}},s.prototype=Object.assign(Object.create(t.Object3D.prototype),{constructor:s,updateMatrixWorld:(()=>{const e=new t.Vector3,r=new t.Quaternion,o=new t.Vector3,i=new t.Matrix4;return function(s){const n=this.root;if(this.visible){const t=this.physics.bodies;i.copy(n.matrixWorld).decompose(e,r,o).compose(e,r,o.set(1,1,1)).invert();for(let e=0,o=t.length;e<o;e++){const o=t[e].body,s=this.children[e],n=o.getCenterOfMassTransform(),a=n.getOrigin(),h=n.getRotation();s.position.set(a.x(),a.y(),a.z()).applyMatrix4(i),s.quaternion.setFromRotationMatrix(i).multiply(r.set(h.x(),h.y(),h.z(),h.w()))}}this.matrix.copy(n.matrixWorld).decompose(e,r,o).compose(e,r,o.set(1,1,1)),t.Object3D.prototype.updateMatrixWorld.call(this,s)}})(),_init:function(){const e=this.physics.bodies;function r(e){switch(e.shapeType){case 0:return new t.SphereGeometry(e.width,16,8);case 1:return new t.BoxGeometry(2*e.width,2*e.height,2*e.depth,8,8,8);case 2:return new o(e.width,e.height,16,8);default:return null}}function o(e,r,o,i){const s=new t.CylinderGeometry(e,e,r,o,i,!0),n=new t.Mesh(new t.SphereGeometry(e,o,i,0,2*Math.PI,0,Math.PI/2)),a=new t.Mesh(new t.SphereGeometry(e,o,i,0,2*Math.PI,Math.PI/2,Math.PI/2));return n.position.set(0,r/2,0),a.position.set(0,-r/2,0),n.updateMatrix(),a.updateMatrix(),s.merge(n.geometry,n.matrix),s.merge(a.geometry,a.matrix),s}for(let o=0,i=e.length;o<i;o++){const i=e[o].params;this.add(new t.Mesh(r(i),this.materials[i.type]))}}}),e})();exports.MMDPhysics=e;
