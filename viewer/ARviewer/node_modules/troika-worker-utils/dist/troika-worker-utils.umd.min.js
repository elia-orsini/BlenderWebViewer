'use strict';(function(k,q){"object"===typeof exports&&"undefined"!==typeof module?q(exports):"function"===typeof define&&define.amd?define(["exports"],q):(k="undefined"!==typeof globalThis?globalThis:k||self,q(k.troika_worker_utils={}))})(this,function(k){function q(){function b(f,c){m++;var w=0;try{c===p&&g();var v=0<f&&e(c);v?v.call(c,a(function(a){w++;b(1,a)}),a(function(a){w++;b(-1,a)})):(r=f,l=c,h||(setTimeout(d,0),h=1))}catch(E){r||w||b(-1,E)}}function d(){var a=f;h=0;f=[];a.forEach(c)}function c(a){a()}
function e(a){a=a&&(n(a)||"object"===typeof a)&&a.then;return n(a)&&a}function a(a){var b=0;return function(){for(var g=[],f=arguments.length;f--;)g[f]=arguments[f];b++||a.apply(this,g)}}function g(){throw new TypeError("Chaining cycle detected");}var r=0,f=[],l,h=0,m=0,v=a(function(a){m||b(1,a)}),k=a(function(a){m||b(-1,a)}),n=function(a){return"function"===typeof a},p={then:function(a,b){var c=q();f.push(function(){var f=0<r?a:b;if(n(f))try{var d=f(l);d===c&&g();var h=e(d);h?h.call(d,c.resolve,
c.reject):c.resolve(d)}catch(F){c.reject(F)}else c[0<r?"resolve":"reject"](l)});r&&!h&&(setTimeout(d,0),h=1);return c},resolve:v,reject:k};return p}function B(){var b,d,c=new Promise(function(c,a){b=c;d=a});return{then:c.then.bind(c),resolve:b,reject:d}}function G(){function b(a,g){var d=a.id,f=a.name,l=a.dependencies;void 0===l&&(l=[]);var h=a.init;void 0===h&&(h=function(){});a=a.getTransferables;void 0===a&&(a=null);if(!e[d])try{l=l.map(function(a){a&&a.isWorkerModule&&(b(a,function(a){if(a instanceof
Error)throw a;}),a=e[a.id].value);return a}),h=c("<"+f+">.init",h),a&&(a=c("<"+f+">.getTransferables",a)),f=null,"function"===typeof h?f=h.apply(void 0,l):console.error("worker module init function failed to rehydrate"),e[d]={id:d,value:f,getTransferables:a},g(f)}catch(m){m&&m.noLog||console.error(m),g(m)}}function d(a,b){function c(a){try{var c=e[g].getTransferables&&e[g].getTransferables(a);c&&Array.isArray(c)&&c.length||(c=void 0);b(a,c)}catch(A){console.error(A),b(A)}}var d,g=a.id;a=a.args;e[g]&&
"function"===typeof e[g].value||b(Error("Worker module "+g+": not found or its 'init' did not return a function"));try{var h=(d=e[g]).value.apply(d,a);h&&"function"===typeof h.then?h.then(c,function(a){return b(a instanceof Error?a:Error(""+a))}):c(h)}catch(m){b(m)}}function c(a,b){var c=void 0;self.troikaDefine=function(a){return c=a};a=URL.createObjectURL(new Blob(["/** "+a.replace(/\*/g,"")+" **/\n\ntroikaDefine(\n"+b+"\n)"],{type:"application/javascript"}));try{importScripts(a)}catch(f){console.error(f)}URL.revokeObjectURL(a);
delete self.troikaDefine;return c}var e=Object.create(null);self.addEventListener("message",function(a){var c=a.data,e=c.messageId;a=c.action;c=c.data;try{"registerModule"===a&&b(c,function(a){a instanceof Error?postMessage({messageId:e,success:!1,error:a.message}):postMessage({messageId:e,success:!0,result:{isCallable:"function"===typeof a}})}),"callModule"===a&&d(c,function(a,b){a instanceof Error?postMessage({messageId:e,success:!1,error:a.message}):postMessage({messageId:e,success:!0,result:a},
b||void 0)})}catch(f){postMessage({messageId:e,success:!1,error:f.stack})}})}function H(b){var d=function(){for(var b=[],e=arguments.length;e--;)b[e]=arguments[e];return d._getInitResult().then(function(a){if("function"===typeof a)return a.apply(void 0,b);throw Error("Worker module function was called but `init` did not return a callable function");})};d._getInitResult=function(){var c=b.dependencies,e=b.init;c=Array.isArray(c)?c.map(function(a){return a&&a._getInitResult?a._getInitResult():a}):[];
var a=n.all(c).then(function(a){return e.apply(null,a)});d._getInitResult=function(){return a};return a};return d}function x(b){function d(){for(var a=[],b=arguments.length;b--;)a[b]=arguments[b];if(!l){l=C(g,"registerModule",d.workerModuleData);var c=function(){l=null;p[g].delete(c)};(p[g]||(p[g]=new Set)).add(c)}return l.then(function(b){if(b.isCallable)return C(g,"callModule",{id:k,args:a});throw Error("Worker module function was called but `init` did not return a callable function");})}if(!(b&&
"function"===typeof b.init||y))throw Error("requires `options.init` function");var c=b.dependencies,e=b.init,a=b.getTransferables,g=b.workerId;if(!D())return H(b);null==g&&(g="#default");var k="workerModule"+ ++I,f=b.name||k,l=null;c=c&&c.map(function(a){"function"!==typeof a||a.workerModuleData||(y=!0,a=x({workerId:g,name:"<"+f+"> function dependency: "+a.name,init:"function(){return (\n"+t(a)+"\n)}"}),y=!1);a&&a.workerModuleData&&(a=a.workerModuleData);return a});d.workerModuleData={isWorkerModule:!0,
id:k,name:f,dependencies:c,init:t(e),getTransferables:a&&t(a)};return d}function t(b){b=b.toString();!/^function/.test(b)&&/^\w+\s*\(/.test(b)&&(b="function "+b);return b}function J(b){var d=u[b];d||(d=t(G),d=u[b]=new Worker(URL.createObjectURL(new Blob(["/** Worker Module Bootstrap: "+b.replace(/\*/g,"")+" **/\n\n;("+d+")()"],{type:"application/javascript"}))),d.onmessage=function(b){b=b.data;var c=b.messageId,a=z[c];if(!a)throw Error("WorkerModule response with empty or unknown messageId");delete z[c];
a(b)});return d}function C(b,d,c){var e=n(),a=++K;z[a]=function(a){a.success?e.resolve(a.result):e.reject(Error("Error in worker "+d+" call: "+a.error))};J(b).postMessage({messageId:a,action:d,data:c});return e}q.all=B.all=function(b){var d=0,c=[],e=n();0===b.length?e.resolve([]):b.forEach(function(a,g){var k=n();k.resolve(a);k.then(function(a){d++;c[g]=a;d===b.length&&e.resolve(c)},e.reject)});return e};var n="function"===typeof Promise?B:q,D=function(){var b=!1;if("undefined"!==typeof window&&"undefined"!==
typeof window.document)try{(new Worker(URL.createObjectURL(new Blob([""],{type:"application/javascript"})))).terminate(),b=!0}catch(d){"undefined"!==typeof process&&"test"===process.env.NODE_ENV||console.log("Troika createWorkerModule: web workers not allowed; falling back to main thread execution. Cause: ["+d.message+"]")}D=function(){return b};return b},I=0,K=0,y=!1,u=Object.create(null),p=Object.create(null),z=Object.create(null),L=x({name:"Thenable",dependencies:[n],init:function(b){return b}});
k.Thenable=n;k.ThenableWorkerModule=L;k.defineWorkerModule=x;k.stringifyFunction=t;k.terminateWorker=function(b){p[b]&&p[b].forEach(function(b){b()});u[b]&&(u[b].terminate(),delete u[b])};Object.defineProperty(k,"__esModule",{value:!0})})
